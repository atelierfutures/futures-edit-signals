<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Signals</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;max-width:1100px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#f2f2f2;font-size:12px;border:1px solid #e6e6e6;cursor:pointer}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
  .search input,.controls select,.controls input[type=date]{padding:8px 10px;border:1px solid #ddd;border-radius:8px}
  .search{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  th.sortable{cursor:pointer}
  th.sortable .arrow{opacity:.35;margin-left:6px}
  th.sortable.active .arrow{opacity:1}
  #counts{font-size:14px;color:#555;margin:8px 0}
  mark{background:#ffe58a;padding:0 .15em;border-radius:3px}
  .pager{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .pager .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .pager .btn[disabled]{opacity:.5;cursor:not-allowed}
</style>

<header>
  <h1>The Futures Edit — Signals (auto)</h1>
  <div class="controls">
    <label>Category:
      <select id="cat">
        <option value="">All</option>
        <option>fashion</option><option>beauty</option><option>wellness</option>
      </select>
    </label>
    <label>Status:
      <select id="stat">
        <option value="">All</option>
        <option>emerging</option><option>bubbling</option><option>mainstream</option>
      </select>
    </label>

    <!-- Date range -->
    <label>From: <input id="from" type="date"></label>
    <label>To: <input id="to" type="date"></label>
    <label>Quick:
      <select id="quick">
        <option value="">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
    </label>
    <button id="clearDates" type="button" class="pill">Clear dates</button>

    <!-- Search + download -->
    <div class="search">
      <input id="q" type="search" placeholder="Search title / keyword / category / status… (Esc to clear)" />
      <a id="dl" class="pill" href="signals_simple.csv" download>Download CSV</a>
    </div>
  </div>
</header>

<div id="counts">Loading…</div>

<table id="tbl">
  <thead>
    <tr>
      <th class="sortable" data-key="published">Published <span class="arrow">↕</span></th>
      <th class="sortable" data-key="title">Title <span class="arrow">↕</span></th>
      <th class="sortable" data-key="category" style="width:110px">Category <span class="arrow">↕</span></th>
      <th class="sortable" data-key="primary_keyword" style="width:180px">Keyword <span class="arrow">↕</span></th>
      <th class="sortable" data-key="trend_score" style="width:120px">Trend score <span class="arrow">↕</span></th>
      <th class="sortable" data-key="status" style="width:120px">Status <span class="arrow">↕</span></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pager">
  <span>Rows per page:</span>
  <select id="pageSize">
    <option>25</option>
    <option selected>50</option>
    <option>100</option>
    <option>200</option>
  </select>
  <span id="pageInfo">Page 1 of 1</span>
  <button class="btn" id="prevBtn">‹ Prev</button>
  <button class="btn" id="nextBtn">Next ›</button>
</div>

<script>
const tbody   = document.querySelector("#tbl tbody");
const cat     = document.getElementById("cat");
const stat    = document.getElementById("stat");
const q       = document.getElementById("q");
const counts  = document.getElementById("counts");
const headers = [...document.querySelectorAll("th.sortable")];

const fromInp = document.getElementById("from");
const toInp   = document.getElementById("to");
const quick   = document.getElementById("quick");
const clearBtn= document.getElementById("clearDates");

const pageSizeSel = document.getElementById("pageSize");
const prevBtn  = document.getElementById("prevBtn");
const nextBtn  = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");

let rowsAll = [];
let sortKey = "trend_score";   // default sort
let sortDir = "desc";
let currentPage = 1;
let pageSize = parseInt(pageSizeSel.value,10) || 50;

const statusOrder = {emerging:0, bubbling:1, mainstream:2};

function escRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

function cmp(a,b,key){
  const dir = sortDir === "asc" ? 1 : -1;
  if(key === "trend_score"){
    const x = parseFloat(a.trend_score||0), y = parseFloat(b.trend_score||0);
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "published"){
    const x = Date.parse(a.published||"") || 0;
    const y = Date.parse(b.published||"") || 0;
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "status"){
    const x = statusOrder[(a.status||"").toLowerCase()] ?? 99;
    const y = statusOrder[(b.status||"").toLowerCase()] ?? 99;
    return (x<y?-1:x>y?1:0)*dir;
  }
  const x = (a[key]||"").toString().toLowerCase();
  const y = (b[key]||"").toString().toLowerCase();
  return (x<y?-1:x>y?1:0)*dir;
}

function setSort(key){
  if(sortKey === key){
    sortDir = (sortDir === "asc") ? "desc" : "asc";
  } else {
    sortKey = key;
    sortDir = (key === "trend_score" || key === "published") ? "desc" : "asc";
  }
  currentPage = 1; // reset on sort
  headers.forEach(h=>{
    h.classList.toggle("active", h.dataset.key === sortKey);
    h.querySelector(".arrow").textContent = h.dataset.key === sortKey ? (sortDir==="asc"?"↑":"↓") : "↕";
  });
  render();
}
headers.forEach(h => h.addEventListener("click", () => setSort(h.dataset.key)));

function tokenize(s){
  return (s||"").toLowerCase().trim().split(/\s+/).filter(Boolean);
}
function matches(row, query){
  const toks = tokenize(query);
  if(!toks.length) return true;
  const hay = [
    row.title||"", row.primary_keyword||"",
    row.category||"", (row.status||"").toLowerCase()
  ].join(" ").toLowerCase();
  return toks.every(t => hay.includes(t));
}
function highlight(str, query){
  let out = str||"";
  tokenize(query).forEach(t=>{
    const re = new RegExp("(" + escRegExp(t) + ")", "ig");
    out = out.replace(re, "<mark>$1</mark>");
  });
  return out;
}

// date helpers
function dayStartISO(d){ return new Date(new Date(d).setUTCHours(0,0,0,0)); }
function dayEndISO(d){ return new Date(new Date(d).setUTCHours(23,59,59,999)); }
function applyQuickRange(days){
  if(!days){ fromInp.value=""; toInp.value=""; currentPage=1; render(); return; }
  const today = new Date();
  const start = new Date(today.getTime() - days*86400000);
  fromInp.value = start.toISOString().slice(0,10);
  toInp.value   = today.toISOString().slice(0,10);
  currentPage = 1;
  render();
}

function getFilteredSortedRows(){
  const c=cat.value, s=stat.value, query=q.value;
  const fromMs = fromInp.value ? dayStartISO(fromInp.value).getTime() : -Infinity;
  const toMs   = toInp.value   ? dayEndISO(toInp.value).getTime()   :  Infinity;

  let rows = rowsAll.filter(r => {
    if (c && r.category !== c) return false;
    if (s && (r.status||"").toLowerCase() !== s) return false;
    if (!matches(r, query)) return false;
    const pubMs = Date.parse(r.published || "");
    if (fromMs !== -Infinity || toMs !== Infinity){
      if (isNaN(pubMs)) return false;
      if (pubMs < fromMs || pubMs > toMs) return false;
    }
    return true;
  });

  rows = rows.sort((a,b)=>cmp(a,b,sortKey));
  return rows;
}

function render(){
  const rows = getFilteredSortedRows();
  const total = rows.length;

  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1) * pageSize;
  const end   = Math.min(start + pageSize, total);
  const slice = rows.slice(start, end);

  tbody.innerHTML = slice.map(r => `
    <tr>
      <td>${(r.published||"").slice(0,10)}</td>
      <td><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></td>
      <td><span class="pill">${r.category||""}</span></td>
      <td>${highlight(r.primary_keyword||"", q.value)}</td>
      <td>${r.trend_score ?? ""}</td>
      <td><span class="pill">${(r.status||"").toLowerCase()}</span></td>
    </tr>
  `).join("");

  // counts line
  const cats = ["fashion","beauty","wellness"].map(k => [k, rows.filter(x=>x.category===k).length]);
  const stats= ["emerging","bubbling","mainstream"].map(k => [k, rows.filter(x=>(x.status||"").toLowerCase()===k).length]);
  counts.textContent = `Showing ${start+1}-${end} of ${total} • ` +
    cats.map(x=>`${x[0]} ${x[1]}`).join(" • ") + " • " +
    stats.map(x=>`${x[0]} ${x[1]}`).join(" • ");

  // pager UI
  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= totalPages;
}

// events
cat.onchange = () => { currentPage=1; render(); };
stat.onchange = () => { currentPage=1; render(); };
q.addEventListener("input", () => { currentPage=1; render(); });
window.addEventListener("keydown", e => { if(e.key === "Escape"){ q.value=""; currentPage=1; render(); }});
fromInp.onchange = () => { currentPage=1; render(); };
toInp.onchange   = () => { currentPage=1; render(); };
quick.onchange   = () => applyQuickRange(parseInt(quick.value) || 0);
clearBtn.onclick = () => { fromInp.value=""; toInp.value=""; quick.value=""; currentPage=1; render(); };

pageSizeSel.onchange = () => { pageSize = parseInt(pageSizeSel.value,10) || 50; currentPage=1; render(); };
prevBtn.onclick = () => { if(currentPage>1){ currentPage--; render(); } };
nextBtn.onclick = () => { currentPage++; render(); };

function load(){
  const bust = new Date().toISOString().slice(0,10); // daily cache-bust
  fetch("signals_simple.csv?ts="+bust)
    .then(r => r.text())
    .then(csv => Papa.parse(csv, {header:true, skipEmptyLines:true}))
    .then(res => { rowsAll = res.data; setSort("trend_score"); }) // default sort: score ↓
    .catch(() => { counts.textContent = "Failed to load CSV"; });
}
load();
</script>
