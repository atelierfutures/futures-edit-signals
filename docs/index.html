<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Signals</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#fff; --fg:#161616; --muted:#6b7280;
    --card:#fff; --border:#e5e7eb; --pill:#f5f6f8; --accent:#0f172a;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --barH: 64px;                 /* JS keeps this in sync with the sticky bar */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}

  /* === top bar ============================================================= */
  .bar{position:sticky;top:0;z-index:100;backdrop-filter:saturate(180%) blur(10px);
       background:color-mix(in oklab, var(--bg) 92%, transparent);
       border-bottom:1px solid var(--border)}
  .bar-inner{max-width:1100px;margin:0 auto;padding:10px 20px;display:flex;flex-wrap:wrap;gap:10px}
  .title{font-weight:700;font-size:18px;margin-right:auto}
  .btn{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .select,.input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);box-shadow:var(--shadow)}
  .input{min-width:260px}
  /* add a little extra room on the right for the native chevron */
  select.select{padding-right:32px}

  .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:var(--shadow)}
  .seg button{padding:8px 14px;border:0;background:var(--card);color:var(--fg);cursor:pointer}
  .seg button.active{background:var(--accent);color:#fff}

  .menu{position:relative}
  .menu-panel{display:none;position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:var(--card);
    border:1px solid var(--border);border-radius:10px;padding:8px;box-shadow:var(--shadow);z-index:120}
  .menu-panel.open{display:block}
  .menu-panel a,.menu-panel button{display:flex;align-items:center;gap:8px;width:100%;padding:10px;border:0;background:transparent;color:var(--fg);text-decoration:none;cursor:pointer;border-radius:8px}
  .menu-panel a:hover,.menu-panel button:hover{background:var(--pill)}

  .wrap{max-width:1100px;margin:0 auto;padding:10px 20px}

  /* === table =============================================================== */
  .table-wrap{overflow-x:auto}           /* enables horizontal scroll on narrow screens */
  table{width:100%;border-collapse:collapse;min-width:940px}
  col.col-date{width:170px}
  col.col-title{width:42%}               /* a tad narrower so others breathe more */
  col.col-cat{width:120px}
  col.col-key{width:160px}
  col.col-score{width:120px}
  col.col-status{width:130px}

  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;background:var(--bg)}
  thead th{position:sticky;top:var(--barH);z-index:1}  /* sits right under the sticky toolbar */

  /* keep header label + arrow on ONE line, arrow only when sorted */
  th .h{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
  th .arrow{display:none;min-width:10px}                 /* hidden by default */
  th.active .arrow{display:inline-block}                 /* only the active header shows it */

  /* simple pills for category/status */
  .pill{padding:4px 8px;font-size:11px;line-height:1;border:1px solid var(--border);border-radius:999px;background:var(--pill);display:inline-block}
  .tag--fashion{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .tag--beauty{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .tag--wellness{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
  .status--emerging{background:#ecfccb;border-color:#bef264;color:#3f6212}
  .status--bubbling{background:#fef3c7;border-color:#fcd34d;color:#92400e}
  .status--mainstream{background:#f1f5f9;border-color:#cbd5e1;color:#334155}

  /* chips row under bar (optional) */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .chip{display:inline-flex;align-items:center;gap:6px}
  .chip button{all:unset;cursor:pointer;color:var(--muted)}

  /* small helpers */
  .date{color:var(--muted);white-space:nowrap}
  .muted{color:var(--muted)}
</style>

<div class="bar" id="bar">
  <div class="bar-inner">
    <div class="title">The Futures Edit — Signals</div>
    <input id="q" class="input" type="search" placeholder="Search title / keyword / category / status… (Esc to clear)" />
    <select id="sortKey" class="select">
      <option value="trend_score">Sort: Trend score</option>
      <option value="published">Sort: Published</option>
      <option value="title">Sort: Title</option>
      <option value="category">Sort: Category</option>
      <option value="primary_keyword">Sort: Keyword</option>
      <option value="status">Sort: Status</option>
    </select>

    <div class="seg">
      <button id="viewTable" class="active" type="button">Table</button>
      <button id="viewCards" type="button">Cards</button>
    </div>

    <select id="barCat" class="select">
      <option value="">All categories</option>
      <option>fashion</option><option>beauty</option><option>wellness</option>
    </select>
    <select id="barStatus" class="select">
      <option value="">All status</option>
      <option>emerging</option><option>bubbling</option><option>mainstream</option>
    </select>

    <button id="filtersBtn" class="btn" type="button">Dates</button>

    <div class="menu" style="margin-left:auto">
      <button class="btn" id="moreBtn">More</button>
      <div class="menu-panel" id="moreMenu">
        <a href="signals_simple.csv" download>Download CSV</a>
        <button id="copyFiltered">Copy filtered CSV</button>
        <button id="copyShare">Copy share link</button>
        <button id="resetAll">Reset all</button>
        <button id="darkToggle">Toggle dark mode</button>
        <a href="https://github.com/atelierfutures/futures-edit-signals" target="_blank" rel="noopener">Repository</a>
        <a href="tags.html" target="_blank" rel="noopener">Tags graph</a>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="chips" class="chips"></div>

  <div class="table-wrap">
    <table id="tbl">
      <colgroup>
        <col class="col-date"><col class="col-title"><col class="col-cat"><col class="col-key"><col class="col-score"><col class="col-status">
      </colgroup>
      <thead>
        <tr>
          <th class="sortable" data-key="published"><span class="h">Published <span class="arrow"></span></span></th>
          <th class="sortable" data-key="title"><span class="h">Title <span class="arrow"></span></span></th>
          <th class="sortable" data-key="category"><span class="h">Category <span class="arrow"></span></span></th>
          <th class="sortable" data-key="primary_keyword"><span class="h">Keyword <span class="arrow"></span></span></th>
          <th class="sortable" data-key="trend_score"><span class="h">Trend score <span class="arrow"></span></span></th>
          <th class="sortable" data-key="status"><span class="h">Status <span class="arrow"></span></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="cards" style="display:none"></div>

  <div class="chips muted" id="rangeInfo">Loading…</div>
</div>

<!-- Dates drawer (simple) -->
<div id="drawer" hidden style="position:fixed;inset:auto 0 0 auto;width:360px;max-width:90vw;background:var(--bg);border:1px solid var(--border);border-radius:12px 12px 0 0;box-shadow:var(--shadow);padding:16px;z-index:200">
  <h3 style="margin:0 0 10px">Date range</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <label>From <input id="from" type="date" class="select" style="width:100%"></label>
    <label>To <input id="to" type="date" class="select" style="width:100%"></label>
    <label style="grid-column:1 / -1">Quick
      <select id="quick" class="select" style="width:100%">
        <option value="">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
    </label>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button id="clearDates" class="btn">Clear dates</button>
    <button id="applyFilters" class="btn">Apply</button>
    <button id="closeDrawer" class="btn">Close</button>
  </div>
</div>

<script>
/* ---------- refs ---------- */
const bar = document.getElementById("bar");
const tbody   = document.querySelector("#tbl tbody");
const cardsEl = document.getElementById("cards");
const q = document.getElementById("q");
const sortKeySel = document.getElementById("sortKey");
const viewTableBtn = document.getElementById("viewTable");
const viewCardsBtn = document.getElementById("viewCards");
const barCatSel = document.getElementById("barCat");
const barStatusSel = document.getElementById("barStatus");
const rangeInfo= document.getElementById("rangeInfo");
const headers = [...document.querySelectorAll("th.sortable")];
/* drawer */
const drawer = document.getElementById("drawer");
const filtersBtn = document.getElementById("filtersBtn");
const closeDrawer = document.getElementById("closeDrawer");
const applyFilters = document.getElementById("applyFilters");
const fromI = document.getElementById("from");
const toI   = document.getElementById("to");
const quick = document.getElementById("quick");
const clearDatesBtn = document.getElementById("clearDates");
/* menu */
const moreBtn  = document.getElementById("moreBtn");
const moreMenu = document.getElementById("moreMenu");
const copyFilteredBtn = document.getElementById("copyFiltered");
const copyShareBtn = document.getElementById("copyShare");
const resetAllBtn = document.getElementById("resetAll");
const darkToggleBtn = document.getElementById("darkToggle");

/* ---------- state ---------- */
let rowsAll = [];
let viewMode = "table";
let sortKey = "trend_score";
let sortDir = "desc";

const statusOrder = {emerging:0, bubbling:1, mainstream:2};
const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
const catClass = c => c && ["fashion","beauty","wellness"].includes(c) ? `pill tag--${c}` : "pill";
const statusClass = s => s ? `pill status--${s.toLowerCase()}` : "pill";

/* time in Madrid */
const fmtDate = new Intl.DateTimeFormat('es-ES',
  {timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});

function fmtDateTime(iso){
  try{
    const d = new Date(iso);
    if(isNaN(d)) return iso;
    return fmtDate.format(d).replace(",", "");
  }catch{ return iso || ""; }
}

/* measure sticky bar height -> set CSS var used by sticky thead */
function setBarHeight(){
  document.documentElement.style.setProperty('--barH', bar.offsetHeight + 'px');
}
new ResizeObserver(setBarHeight).observe(bar);
window.addEventListener('load', setBarHeight);
window.addEventListener('orientationchange', setBarHeight);

/* theme */
(()=>{ const saved = localStorage.getItem("fe_theme"); if(saved==="dark") document.documentElement.classList.add("dark"); })();
darkToggleBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("fe_theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
};

/* pretty menu */
function toggleMenu(open){
  moreMenu.classList.toggle('open', open);
  moreBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
  setBarHeight(); // if the menu opens, bar height changes
}
moreBtn.onclick = (e)=>{ e.stopPropagation(); toggleMenu(!moreMenu.classList.contains('open')); };
document.addEventListener('click', (e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn) toggleMenu(false); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleMenu(false); });

/* sorting UI */
function updateSortUI(){
  sortKeySel.value = sortKey;
  headers.forEach(h=>{
    const active = h.dataset.key === sortKey;
    h.classList.toggle("active", active);
    const arrow = h.querySelector(".arrow");
    if(arrow){
      arrow.textContent = active ? (sortDir==="asc" ? "↑" : "↓") : "";
    }
  });
}
function cmp(a,b,key){
  const dir = sortDir === "asc" ? 1 : -1;
  if(key === "trend_score"){
    const x = parseFloat(a.trend_score||0), y = parseFloat(b.trend_score||0);
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "published"){
    const x = Date.parse(a.published||"") || 0;
    const y = Date.parse(b.published||"") || 0;
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "status"){
    const x = statusOrder[(a.status||"").toLowerCase()] ?? 99;
    const y = statusOrder[(b.status||"").toLowerCase()] ?? 99;
    return (x<y?-1:x>y?1:0)*dir;
  }
  const x = (a[key]||"").toString().toLowerCase();
  const y = (b[key]||"").toString().toLowerCase();
  return (x<y?-1:x>y?1:0)*dir;
}
function setSort(key){
  if(sortKey === key){ sortDir = (sortDir === "asc") ? "desc" : "asc"; }
  else { sortKey = key; sortDir = (key === "trend_score" || key === "published") ? "desc" : "asc"; }
  updateSortUI(); render();
}
headers.forEach(h => h.addEventListener("click", () => setSort(h.dataset.key)));
sortKeySel.onchange = () => { sortKey = sortKeySel.value; sortDir = (sortKey==="trend_score"||sortKey==="published")?"desc":"asc"; updateSortUI(); render(); };

/* view toggle */
function setView(mode){
  viewMode = mode;
  viewTableBtn.classList.toggle("active", mode==="table");
  viewCardsBtn.classList.toggle("active", mode==="cards");
  document.getElementById("tbl").closest('.table-wrap').style.display = mode==="table" ? "" : "none";
  document.getElementById("cards").style.display = mode==="cards" ? "" : "none";
  render();
}
viewTableBtn.onclick  = () => setView("table");
viewCardsBtn.onclick  = () => setView("cards");

/* search + filters */
const tokenize = s => (s||"").toLowerCase().trim().split(/\s+/).filter(Boolean);
function matches(row, query){
  const toks = tokenize(query);
  if(!toks.length) return true;
  const hay = [row.title||"", row.primary_keyword||"", row.category||"", (row.status||"").toLowerCase()].join(" ").toLowerCase();
  return toks.every(t => hay.includes(t));
}
q.addEventListener("input", render);
barCatSel.onchange   = render;
barStatusSel.onchange= render;

filtersBtn.onclick = ()=> drawer.hidden = false;
closeDrawer.onclick = ()=> drawer.hidden = true;
applyFilters.onclick = ()=>{ drawer.hidden = true; render(); };
clearDatesBtn.onclick = ()=>{ fromI.value=""; toI.value=""; quick.value=""; };

quick.onchange = () => {
  const days = parseInt(quick.value) || 0;
  if(!days){ fromI.value=""; toI.value=""; return; }
  const today = new Date(); const start = new Date(today.getTime()-days*86400000);
  fromI.value = start.toISOString().slice(0,10);
  toI.value   = today.toISOString().slice(0,10);
};

/* helpers */
function highlight(str, query){
  let out = str||"";
  tokenize(query).forEach(t=>{
    const re = new RegExp("(" + escRe(t) + ")", "ig");
    out = out.replace(re, "<mark>$1</mark>");
  });
  return out;
}
function catPill(c){ if(!c) return "";
  const href="./?cat="+encodeURIComponent(c);
  return `<a class="pill ${"tag--"+c}" href="${href}" target="_blank" rel="noopener">${c}</a>`;
}
function statusPill(s){ if(!s) return "";
  const v=s.toLowerCase(), href="./?stat="+encodeURIComponent(v);
  return `<a class="pill ${"status--"+v}" href="${href}" target="_blank" rel="noopener">${v}</a>`;
}

/* pipeline */
function getFilteredSortedRows(){
  const query=q.value, c=barCatSel.value, s=barStatusSel.value;
  const fromMs = fromI.value ? new Date(new Date(fromI.value).setUTCHours(0,0,0,0)).getTime() : -Infinity;
  const toMs   = toI.value   ? new Date(new Date(toI.value).setUTCHours(23,59,59,999)).getTime() :  Infinity;

  let rows = rowsAll.filter(r => {
    if (c && r.category !== c) return false;
    if (s && (r.status||"").toLowerCase() !== s) return false;
    if (!matches(r, query)) return false;
    const pubMs = Date.parse(r.published || "");
    if (fromMs !== -Infinity || toMs !== Infinity){
      if (isNaN(pubMs)) return false;
      if (pubMs < fromMs || pubMs > toMs) return false;
    }
    return true;
  });

  rows = rows.sort((a,b)=>cmp(a,b,sortKey));
  return rows;
}

/* render */
function render(){
  const rows = getFilteredSortedRows();
  updateSortUI();

  rangeInfo.textContent = `${rows.length} results`;

  if(viewMode==="table"){
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td class="date">${fmtDateTime(r.published)}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></td>
        <td>${catPill(r.category)}</td>
        <td>${highlight(r.primary_keyword||"", q.value)}</td>
        <td>${r.trend_score ?? ""}</td>
        <td>${statusPill(r.status)}</td>
      </tr>
    `).join("");
  } else {
    cardsEl.innerHTML = rows.map(r => `
      <div class="pill" style="display:block;padding:12px;margin:8px 0">
        <div class="date">${fmtDateTime(r.published)}</div>
        <div style="font-weight:600;margin:6px 0"><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${catPill(r.category)}
          ${statusPill(r.status)}
          ${(r.primary_keyword||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,1).map(k=>`<span class="pill">${highlight(k,q.value)}</span>`).join("")}
          <span class="muted">score ${r.trend_score ?? ""}</span>
        </div>
      </div>
    `).join("");
  }
}

/* reset / share */
resetAllBtn.onclick = () => {
  q.value=""; sortKey="trend_score"; sortDir="desc";
  barCatSel.value=""; barStatusSel.value="";
  fromI.value=""; toI.value=""; quick.value="";
  setView("table"); render();
  toggleMenu(false);
};
copyFilteredBtn.onclick = async () => {
  const rows = getFilteredSortedRows();
  const header = ["published","title","link","category","primary_keyword","trend_score","status"];
  const csv = [header.join(",")].concat(rows.map(r => header.map(h => `"${(r[h]??"").toString().replace(/"/g,'""')}"`).join(","))).join("\n");
  try { await navigator.clipboard.writeText(csv);
    copyFilteredBtn.textContent = "Copied!"; setTimeout(()=> copyFilteredBtn.textContent="Copy filtered CSV", 1400);
  } catch {
    const blob = new Blob([csv], {type:"text/csv"}); const a = Object.assign(document.createElement("a"), {href:URL.createObjectURL(blob), download:"signals_filtered.csv"}); document.body.appendChild(a); a.click(); a.remove();
  }
};
copyShareBtn.onclick = async () => {
  const url = new URL(location.href);
  const p = new URLSearchParams();
  if(q.value) p.set("q", q.value);
  if(barCatSel.value) p.set("cat", barCatSel.value);
  if(barStatusSel.value) p.set("stat", barStatusSel.value);
  if(fromI.value) p.set("from", fromI.value);
  if(toI.value) p.set("to", toI.value);
  if(viewMode!=="table") p.set("view", viewMode);
  if(sortKey!=="trend_score") p.set("sort", sortKey);
  if(sortDir!=="desc") p.set("dir", sortDir);
  url.search = p.toString();
  try { await navigator.clipboard.writeText(url.toString());
    copyShareBtn.textContent = "Link copied!"; setTimeout(()=> copyShareBtn.textContent="Copy share link", 1400);
  } catch {}
};

/* load */
function load(){
  const bust = new Date().toISOString().slice(0,10);
  fetch("signals_simple.csv?ts="+bust)
    .then(r => r.text())
    .then(csv => Papa.parse(csv, {header:true, skipEmptyLines:true}))
    .then(res => { rowsAll = res.data; render(); })
    .catch(() => { rangeInfo.textContent = "Failed to load CSV"; });
}
load();
</script>
