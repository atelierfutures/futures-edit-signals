<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Signals</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{--gap:12px;--pill:#f2f2f2;--border:#e6e6e6}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;gap:var(--gap);align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:28px;margin:0 0 8px}
  .controls{display:grid;gap:var(--gap);grid-template-columns:repeat(8,minmax(140px,1fr));align-items:center}
  .search{display:flex;gap:8px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px;border:1px solid var(--border);cursor:pointer}
  input[type="search"],select,input[type="date"]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:100%}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  th.sortable{cursor:pointer}
  th.sortable .arrow{opacity:.35;margin-left:6px}
  th.sortable.active .arrow{opacity:1}
  #counts{font-size:14px;color:#555;margin:8px 0}
  mark{background:#ffe58a;padding:0 .15em;border-radius:3px}
  .pager{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .pager .btn{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .pager .btn[disabled]{opacity:.5;cursor:not-allowed}
  .hidden{display:none}

  /* Cards */
  .cards{display:grid;gap:12px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px}
  .card .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:#555}
  .score{padding:2px 8px;border:1px solid var(--border);border-radius:999px}

  /* segmented buttons */
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .seg button{padding:8px 12px;border:0;background:#fff;cursor:pointer}
  .seg button.active{background:#111;color:#fff}
  /* responsive grid tweaks */
  @media (max-width: 980px){ .controls{grid-template-columns:repeat(4,minmax(140px,1fr))} }
  @media (max-width: 720px){ body{margin:16px} .controls{grid-template-columns:repeat(2,minmax(150px,1fr))} }
</style>

<div class="wrap">
  <header>
    <h1>The Futures Edit — Signals (auto)</h1>
    <div class="controls">
      <label>Category:
        <select id="cat">
          <option value="">All</option>
          <option>fashion</option><option>beauty</option><option>wellness</option>
        </select>
      </label>
      <label>Status:
        <select id="stat">
          <option value="">All</option>
          <option>emerging</option><option>bubbling</option><option>mainstream</option>
        </select>
      </label>

      <!-- Date range (Clear next to From/To) -->
      <label>From: <input id="from" type="date"></label>
      <label>To: <input id="to" type="date"></label>
      <button id="clearDates" type="button" class="pill">Clear dates</button>

      <!-- Quick after the date block -->
      <label>Quick:
        <select id="quick">
          <option value="">All time</option>
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </label>

      <!-- View + Sort controls (always available) -->
      <div>
        <label style="display:block;margin-bottom:6px">View:</label>
        <div class="seg">
          <button id="viewList" class="active" type="button">List</button>
          <button id="viewCards" type="button">Cards</button>
        </div>
      </div>
      <div>
        <label style="display:block;margin-bottom:6px">Sort:</label>
        <div style="display:flex;gap:8px">
          <select id="sortKey">
            <option value="trend_score" selected>Trend score</option>
            <option value="published">Published</option>
            <option value="title">Title</option>
            <option value="category">Category</option>
            <option value="primary_keyword">Keyword</option>
            <option value="status">Status</option>
          </select>
          <button id="sortDir" class="pill" type="button">↓ Desc</button>
        </div>
      </div>

      <!-- Search + download full width -->
      <div class="search" style="grid-column:1 / -1">
        <input id="q" type="search" placeholder="Search title / keyword / category / status… (Esc to clear)" />
        <a id="dl" class="pill" href="signals_simple.csv" download>Download CSV</a>
      </div>
    </div>
  </header>

  <div id="counts">Loading…</div>

  <!-- Desktop table (List view) -->
  <table id="tbl">
    <thead>
      <tr>
        <th class="sortable" data-key="published">Published <span class="arrow">↕</span></th>
        <th class="sortable" data-key="title">Title <span class="arrow">↕</span></th>
        <th class="sortable" data-key="category" style="width:110px">Category <span class="arrow">↕</span></th>
        <th class="sortable" data-key="primary_keyword" style="width:180px">Keyword <span class="arrow">↕</span></th>
        <th class="sortable" data-key="trend_score" style="width:120px">Trend score <span class="arrow">↕</span></th>
        <th class="sortable" data-key="status" style="width:120px">Status <span class="arrow">↕</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Cards view -->
  <div id="cards" class="cards hidden"></div>

  <div class="pager">
    <span>Rows per page:</span>
    <select id="pageSize">
      <option>25</option>
      <option selected>50</option>
      <option>100</option>
      <option>200</option>
    </select>
    <span id="pageInfo">Page 1 of 1</span>
    <button class="btn" id="prevBtn">‹ Prev</button>
    <button class="btn" id="nextBtn">Next ›</button>
  </div>
</div>

<script>
const tbody     = document.querySelector("#tbl tbody");
const cardsEl   = document.getElementById("cards");
const counts    = document.getElementById("counts");
const headers   = [...document.querySelectorAll("th.sortable")];

const cat   = document.getElementById("cat");
const stat  = document.getElementById("stat");
const q     = document.getElementById("q");
const fromI = document.getElementById("from");
const toI   = document.getElementById("to");
const quick = document.getElementById("quick");
const clearBtn = document.getElementById("clearDates");

const pageSizeSel = document.getElementById("pageSize");
const prevBtn  = document.getElementById("prevBtn");
const nextBtn  = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");

const viewListBtn  = document.getElementById("viewList");
const viewCardsBtn = document.getElementById("viewCards");
const sortKeySel   = document.getElementById("sortKey");
const sortDirBtn   = document.getElementById("sortDir");

let rowsAll = [];
let viewMode = "list";            // "list" or "cards"
let sortKey = "trend_score";      // default sort
let sortDir = "desc";
let currentPage = 1;
let pageSize = parseInt(pageSizeSel.value,10) || 50;

const statusOrder = {emerging:0, bubbling:1, mainstream:2};

function escRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

function cmp(a,b,key){
  const dir = sortDir === "asc" ? 1 : -1;
  if(key === "trend_score"){
    const x = parseFloat(a.trend_score||0), y = parseFloat(b.trend_score||0);
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "published"){
    const x = Date.parse(a.published||"") || 0;
    const y = Date.parse(b.published||"") || 0;
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "status"){
    const x = statusOrder[(a.status||"").toLowerCase()] ?? 99;
    const y = statusOrder[(b.status||"").toLowerCase()] ?? 99;
    return (x<y?-1:x>y?1:0)*dir;
  }
  const x = (a[key]||"").toString().toLowerCase();
  const y = (b[key]||"").toString().toLowerCase();
  return (x<y?-1:x>y?1:0)*dir;
}

function setSort(key){
  if(sortKey === key){
    sortDir = (sortDir === "asc") ? "desc" : "asc";
  } else {
    sortKey = key;
    sortDir = (key === "trend_score" || key === "published") ? "desc" : "asc";
  }
  sortKeySel.value = sortKey;
  sortDirBtn.textContent = (sortDir==="asc"?"↑ Asc":"↓ Desc");
  currentPage = 1;
  headers.forEach(h=>{
    h.classList.toggle("active", h.dataset.key === sortKey);
    h.querySelector(".arrow").textContent = h.dataset.key === sortKey ? (sortDir==="asc"?"↑":"↓") : "↕";
  });
  render();
}
headers.forEach(h => h.addEventListener("click", () => setSort(h.dataset.key)));

function setView(mode){
  viewMode = mode;
  viewListBtn.classList.toggle("active", mode==="list");
  viewCardsBtn.classList.toggle("active", mode==="cards");
  document.getElementById("tbl").classList.toggle("hidden", mode!=="list");
  cardsEl.classList.toggle("hidden", mode!=="cards");
  currentPage = 1;
  render();
}

function tokenize(s){ return (s||"").toLowerCase().trim().split(/\s+/).filter(Boolean); }
function matches(row, query){
  const toks = tokenize(query);
  if(!toks.length) return true;
  const hay = [
    row.title||"", row.primary_keyword||"",
    row.category||"", (row.status||"").toLowerCase()
  ].join(" ").toLowerCase();
  return toks.every(t => hay.includes(t));
}
function highlight(str, query){
  let out = str||"";
  tokenize(query).forEach(t=>{
    const re = new RegExp("(" + escRegExp(t) + ")", "ig");
    out = out.replace(re, "<mark>$1</mark>");
  });
  return out;
}

// date helpers
function dayStartISO(d){ return new Date(new Date(d).setUTCHours(0,0,0,0)); }
function dayEndISO(d){ return new Date(new Date(d).setUTCHours(23,59,59,999)); }
function applyQuickRange(days){
  if(!days){ fromI.value=""; toI.value=""; currentPage=1; render(); return; }
  const today = new Date();
  const start = new Date(today.getTime() - days*86400000);
  fromI.value = start.toISOString().slice(0,10);
  toI.value   = today.toISOString().slice(0,10);
  currentPage = 1; render();
}

function getFilteredSortedRows(){
  const c=cat.value, s=stat.value, query=q.value;
  const fromMs = fromI.value ? dayStartISO(fromI.value).getTime() : -Infinity;
  const toMs   = toI.value   ? dayEndISO(toI.value).getTime()   :  Infinity;

  let rows = rowsAll.filter(r => {
    if (c && r.category !== c) return false;
    if (s && (r.status||"").toLowerCase() !== s) return false;
    if (!matches(r, query)) return false;
    const pubMs = Date.parse(r.published || "");
    if (fromMs !== -Infinity || toMs !== Infinity){
      if (isNaN(pubMs)) return false;
      if (pubMs < fromMs || pubMs > toMs) return false;
    }
    return true;
  });

  rows = rows.sort((a,b)=>cmp(a,b,sortKey));
  return rows;
}

function render(){
  const rows = getFilteredSortedRows();
  const total = rows.length;

  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1) * pageSize;
  const end   = Math.min(start + pageSize, total);
  const slice = rows.slice(start, end);

  if(viewMode==="cards"){
    cardsEl.innerHTML = slice.map(r => `
      <div class="card">
        <div class="top">
          <time>${(r.published||"").slice(0,10)}</time>
          <span class="pill">${(r.status||"").toLowerCase()}</span>
        </div>
        <a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a>
        <div class="meta">
          <span class="pill">${r.category||""}</span>
          ${r.primary_keyword ? `<span>${highlight(r.primary_keyword, q.value)}</span>` : ""}
          <span class="score">score ${r.trend_score ?? ""}</span>
        </div>
      </div>
    `).join("");
  } else {
    tbody.innerHTML = slice.map(r => `
      <tr>
        <td>${(r.published||"").slice(0,10)}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></td>
        <td><span class="pill">${r.category||""}</span></td>
        <td>${highlight(r.primary_keyword||"", q.value)}</td>
        <td>${r.trend_score ?? ""}</td>
        <td><span class="pill">${(r.status||"").toLowerCase()}</span></td>
      </tr>
    `).join("");
  }

  // counts line
  const cats = ["fashion","beauty","wellness"].map(k => [k, rows.filter(x=>x.category===k).length]);
  const stats= ["emerging","bubbling","mainstream"].map(k => [k, rows.filter(x=>(x.status||"").toLowerCase()===k).length]);
  counts.textContent = `Showing ${start+1}-${end} of ${total} • ` +
    cats.map(x=>`${x[0]} ${x[1]}`).join(" • ") + " • " +
    stats.map(x=>`${x[0]} ${x[1]}`).join(" • ");

  // pager UI
  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= totalPages;
}

// events
cat.onchange = () => { currentPage=1; render(); };
stat.onchange = () => { currentPage=1; render(); };
q.addEventListener("input", () => { currentPage=1; render(); });
window.addEventListener("keydown", e => { if(e.key === "Escape"){ q.value=""; currentPage=1; render(); }});
fromI.onchange = () => { currentPage=1; render(); };
toI.onchange   = () => { currentPage=1; render(); };
quick.onchange = () => applyQuickRange(parseInt(quick.value) || 0);
clearBtn.onclick = () => { fromI.value=""; toI.value=""; quick.value=""; currentPage=1; render(); };

pageSizeSel.onchange = () => { pageSize = parseInt(pageSizeSel.value,10) || 50; currentPage=1; render(); };
prevBtn.onclick = () => { if(currentPage>1){ currentPage--; render(); } };
nextBtn.onclick = () => { currentPage++; render(); };

viewListBtn.onclick  = () => setView("list");
viewCardsBtn.onclick = () => setView("cards");

sortKeySel.onchange = () => setSort(sortKeySel.value);
sortDirBtn.onclick  = () => { sortDir = (sortDir==="asc"?"desc":"asc"); setSort(sortKey); };

function load(){
  const bust = new Date().toISOString().slice(0,10); // daily cache-bust
  fetch("signals_simple.csv?ts="+bust)
    .then(r => r.text())
    .then(csv => Papa.parse(csv, {header:true, skipEmptyLines:true}))
    .then(res => { rowsAll = res.data; setSort("trend_score"); setView("list"); })
    .catch(() => { counts.textContent = "Failed to load CSV"; });
}
load();
</script>
