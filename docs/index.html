<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Signals (auto)</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#0f172a; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --shadow:0 8px 24px rgba(0,0,0,.06);
    --pill-fash:#fee2e2; --pill-beau:#e0e7ff; --pill-well:#dcfce7;
    --pill-emer:#dcfce7; --pill-bubb:#fef9c3; --pill-main:#e5e7eb;
    --accent:#111827;
  }
  :root.dark{
    --bg:#0b0b0c; --fg:#f2f3f5; --muted:#a3a7ae;
    --card:#121317; --border:#2b2f36; --pill:#1b1f25; --shadow:0 10px 30px rgba(0,0,0,.35);
    --pill-fash:#3b1a1a; --pill-beau:#1c2137; --pill-well:#122016;
    --pill-emer:#122016; --pill-bubb:#2a2412; --pill-main:#2b2f36;
    --accent:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#2563eb;text-decoration:none}
  .topbar{position:sticky;top:0;z-index:30;background:color-mix(in oklab, var(--bg) 92%, transparent);
          backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--border)}
  .bar-inner{max-width:1100px;margin:0 auto;padding:12px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .title{font-weight:800;font-size:18px;margin-right:6px}
  .group{display:flex;gap:8px;align-items:center}
  .btn,.select,.input{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow)}
  .btn{cursor:pointer}
  .select{min-width:150px}
  .view-toggle .btn{padding:8px 12px;border-radius:10px}
  .view-toggle .btn.active{background:#0f172a;color:#fff}
  :root.dark .view-toggle .btn.active{background:#e5e7eb;color:#111827}
  .input.search{min-width:280px}
  .spacer{flex:1}
  /* More menu */
  .more-wrap{position:relative}
  .more-btn{min-width:84px}
  .menu{position:absolute;right:0;top:110%;background:var(--card);border:1px solid var(--border);
        border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none;min-width:210px}
  .menu.open{display:block}
  .menu a,.menu button{display:flex;width:100%;text-align:left;background:transparent;border:0;color:var(--fg);
        padding:10px;border-radius:8px;cursor:pointer}
  .menu a:hover,.menu button:hover{background:var(--pill)}
  /* Page */
  .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--pill);font-size:11px;line-height:1}
  .chip a{color:inherit}
  .chip.cat-fashion{background:var(--pill-fash)} .chip.cat-beauty{background:var(--pill-beau)} .chip.cat-wellness{background:var(--pill-well)}
  .chip.stat-emerging{background:var(--pill-emer)} .chip.stat-bubbling{background:var(--pill-bubb)} .chip.stat-mainstream{background:var(--pill-main)}
  .muted{color:var(--muted)}
  /* Table */
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-weight:700;text-align:left;color:var(--muted);padding:4px 10px}
  tbody td{background:var(--card);border:1px solid var(--border);border-left:none;border-right:none;padding:12px 10px}
  tbody tr{box-shadow:var(--shadow);border-radius:12px}
  tbody td:first-child{border-radius:12px 0 0 12px;border-left:1px solid var(--border)}
  tbody td:last-child{border-radius:0 12px 12px 0;border-right:1px solid var(--border)}
  .th-sort{cursor:pointer;user-select:none}
  .th-sort span{opacity:.6;margin-left:6px}
  /* Cards */
  .cards{display:grid;gap:12px}
  @media(min-width:900px){ .cards{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px 14px}
  .card h4{margin:6px 0 8px;font-size:15px}
  .meta-line{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  /* Pagination */
  .pager{display:flex;align-items:center;gap:10px;justify-content:flex-end;margin-top:14px}
  .info{margin-right:auto;color:var(--muted)}
  .rowsel{min-width:100px}
</style>

<div class="topbar">
  <div class="bar-inner">
    <div class="title">The Futures Edit — Signals</div>

    <input id="q" class="input search" type="search" placeholder="Search title / keyword / category / status… (Esc to clear)" />

    <div class="view-toggle group" role="tablist" aria-label="View">
      <button id="btnTable" class="btn active" data-view="table">Table</button>
      <button id="btnCards" class="btn" data-view="cards">Cards</button>
    </div>

    <select id="sortKey" class="select" title="Sort by">
      <option value="trend_score">Sort: Trend score</option>
      <option value="published">Sort: Published</option>
      <option value="title">Sort: Title</option>
    </select>
    <button id="sortDir" class="btn" title="Toggle sort direction">Desc</button>

    <select id="cat" class="select" title="Category">
      <option value="">All categories</option>
      <option>fashion</option><option>beauty</option><option>wellness</option>
    </select>
    <select id="stat" class="select" title="Status">
      <option value="">All status</option>
      <option>emerging</option><option>bubbling</option><option>mainstream</option>
    </select>

    <input id="from" class="input" type="date" title="From date (Madrid)" />
    <input id="to"   class="input" type="date" title="To date (Madrid)" />
    <select id="quick" class="select" title="Quick range">
      <option value="">All time</option>
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="90">Last 90 days</option>
    </select>
    <button id="clearDates" class="btn">Clear</button>

    <div class="spacer"></div>

    <div class="more-wrap">
      <button id="moreBtn" class="btn more-btn">More</button>
      <div id="moreMenu" class="menu" role="menu" aria-label="More">
        <button id="dlCsv" role="menuitem">Download filtered CSV</button>
        <button id="copyLink" role="menuitem">Copy share link</button>
        <button id="resetAll" role="menuitem">Reset all</button>
        <button id="dark" role="menuitem">Toggle dark mode</button>
        <a href="https://github.com/atelierfutures/futures-edit-signals" target="_blank" rel="noopener" role="menuitem">Repository</a>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- COUNTS -->
  <div id="counts" class="muted" style="margin-bottom:10px"></div>

  <!-- TABLE -->
  <div id="viewTable">
    <table aria-label="Signals table">
      <thead>
        <tr>
          <th class="th-sort" data-key="published">Published <span>▼</span> <span class="muted">(Madrid)</span></th>
          <th class="th-sort" data-key="title">Title <span> </span></th>
          <th>Category</th>
          <th>Keyword</th>
          <th class="th-sort" data-key="trend_score">Trend score <span> </span></th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="pager">
      <div id="pageInfo" class="info"></div>
      <label class="muted">Rows
        <select id="rows" class="select rowsel">
          <option>10</option><option selected>25</option><option>50</option><option>100</option>
        </select>
      </label>
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
    </div>
  </div>

  <!-- CARDS -->
  <div id="viewCards" style="display:none">
    <div id="cards" class="cards"></div>

    <div class="pager">
      <div id="pageInfoC" class="info"></div>
      <label class="muted">Rows
        <select id="rowsC" class="select rowsel">
          <option>10</option><option selected>25</option><option>50</option><option>100</option>
        </select>
      </label>
      <button id="prevC" class="btn">Prev</button>
      <button id="nextC" class="btn">Next</button>
    </div>
  </div>
</div>

<script>
/* =================== Madrid TZ utils =================== */
const MADRID_TZ = "Europe/Madrid";

// Pretty "YYYY-MM-DD HH:mm" in Madrid
function fmtMadrid(iso) {
  if (!iso) return "";
  const dt = new Date(iso);
  if (Number.isNaN(dt)) return "";
  const f = new Intl.DateTimeFormat("en-GB", {
    timeZone: MADRID_TZ,
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit",
    hour12: false
  }).formatToParts(dt).reduce((acc, p) => (acc[p.type] = p.value, acc), {});
  return `${f.year}-${f.month}-${f.day} ${f.hour}:${f.minute}`;
}
function tzOffsetMs(tz, utcDate) {
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
  }).formatToParts(utcDate).reduce((o, p) => (o[p.type] = p.value, o), {});
  const asUTC = Date.UTC(parts.year, parts.month - 1, parts.day, parts.hour, parts.minute, parts.second);
  return asUTC - utcDate.getTime();
}
function startOfDayMadrid(ymd) {
  if (!ymd) return null;
  const [y, m, d] = ymd.split("-").map(Number);
  const guessUTC = new Date(Date.UTC(y, (m||1)-1, d||1, 0,0,0));
  const off = tzOffsetMs(MADRID_TZ, guessUTC);
  return new Date(guessUTC.getTime() - off);
}
function endOfDayMadrid(ymd) {
  if (!ymd) return null;
  const [y, m, d] = ymd.split("-").map(Number);
  const guessUTC = new Date(Date.UTC(y, (m||1)-1, d||1, 23,59,59,999));
  const off = tzOffsetMs(MADRID_TZ, guessUTC);
  return new Date(guessUTC.getTime() - off);
}
function rowInDateRangeMadrid(iso, fromYMD, toYMD) {
  const t = Date.parse(iso || "");
  if (Number.isNaN(t)) return false;
  const fromUTC = fromYMD ? startOfDayMadrid(fromYMD).getTime() : -Infinity;
  const toUTC   = toYMD   ? endOfDayMadrid(toYMD).getTime()   :  Infinity;
  return t >= fromUTC && t <= toUTC;
}

/* =================== Theme =================== */
(() => { const s = localStorage.getItem("fe_theme"); if (s === "dark") document.documentElement.classList.add("dark"); })();
document.getElementById("dark").onclick = () => {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("fe_theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
};

/* =================== State =================== */
let rowsAll = [];              // raw CSV rows
let rowsFiltered = [];         // after filters/search/sort
let page = 1, perPage = 25, view = "table";
let sortKey = "trend_score", sortDir = "desc"; // default
const qs = new URLSearchParams(location.search);

/* =================== Elements =================== */
const el = {
  q:     document.getElementById("q"),
  cat:   document.getElementById("cat"),
  stat:  document.getElementById("stat"),
  from:  document.getElementById("from"),
  to:    document.getElementById("to"),
  quick: document.getElementById("quick"),
  clear: document.getElementById("clearDates"),

  sortKey: document.getElementById("sortKey"),
  sortDir: document.getElementById("sortDir"),
  btnTable: document.getElementById("btnTable"),
  btnCards: document.getElementById("btnCards"),

  tbody: document.getElementById("tbody"),
  counts: document.getElementById("counts"),

  prev: document.getElementById("prev"),
  next: document.getElementById("next"),
  rows: document.getElementById("rows"),
  pageInfo: document.getElementById("pageInfo"),

  viewTable: document.getElementById("viewTable"),
  viewCards: document.getElementById("viewCards"),
  cards: document.getElementById("cards"),

  prevC: document.getElementById("prevC"),
  nextC: document.getElementById("nextC"),
  rowsC: document.getElementById("rowsC"),
  pageInfoC: document.getElementById("pageInfoC"),

  moreBtn: document.getElementById("moreBtn"),
  moreMenu: document.getElementById("moreMenu"),
  dlCsv: document.getElementById("dlCsv"),
  copyLink: document.getElementById("copyLink"),
  resetAll: document.getElementById("resetAll"),

  th: [...document.querySelectorAll(".th-sort")]
};

/* =================== Init from URL =================== */
function initFromQuery() {
  if (qs.has("q")) el.q.value = qs.get("q");
  if (qs.has("cat")) el.cat.value = qs.get("cat");
  if (qs.has("stat")) el.stat.value = qs.get("stat");
  if (qs.has("from")) el.from.value = qs.get("from");
  if (qs.has("to")) el.to.value = qs.get("to");
  if (qs.has("sort")) el.sortKey.value = qs.get("sort");
  if (qs.has("dir"))  sortDir = qs.get("dir");
  if (qs.has("view")) view = qs.get("view");
  if (qs.has("page")) page = Math.max(1, parseInt(qs.get("page"), 10) || 1);
  if (qs.has("per"))  perPage = Math.max(1, parseInt(qs.get("per"), 10) || 25);

  el.sortDir.textContent = sortDir === "asc" ? "Asc" : "Desc";
  el.rows.value = String(perPage);
  el.rowsC.value = String(perPage);
  setView(view);
}

/* =================== Events =================== */
["input","change"].forEach(ev => el.q.addEventListener(ev, apply));
el.cat.onchange = apply;
el.stat.onchange = apply;
el.from.onchange = apply;
el.to.onchange = apply;
el.quick.onchange = () => {
  const d = parseInt(el.quick.value,10) || 0;
  if (!d) { el.from.value = ""; el.to.value = ""; apply(); return; }
  const today = new Date();
  const start = new Date(today.getTime() - d*86400000);
  el.from.value = start.toISOString().slice(0,10);
  el.to.value = today.toISOString().slice(0,10);
  apply();
};
el.clear.onclick = () => { el.from.value = ""; el.to.value = ""; el.quick.value = ""; apply(); };

el.sortKey.onchange = () => { sortKey = el.sortKey.value; apply(); };
el.sortDir.onclick  = () => { sortDir = sortDir === "asc" ? "desc" : "asc"; el.sortDir.textContent = sortDir === "asc" ? "Asc" : "Desc"; apply(); };
el.btnTable.onclick = () => { setView("table"); pushURL(); };
el.btnCards.onclick = () => { setView("cards"); pushURL(); };

el.prev.onclick = () => { if (page>1) { page--; render(); pushURL(); } };
el.next.onclick = () => { const maxp = Math.ceil(rowsFiltered.length / perPage)||1; if (page<maxp) { page++; render(); pushURL(); } };
el.rows.onchange = () => { perPage = parseInt(el.rows.value,10)||25; el.rowsC.value = el.rows.value; page=1; render(); pushURL(); };

el.prevC.onclick = el.prev.onclick;
el.nextC.onclick = el.next.onclick;
el.rowsC.onchange = () => { perPage = parseInt(el.rowsC.value,10)||25; el.rows.value = el.rowsC.value; page=1; render(); pushURL(); };

/* Table header sorting */
el.th.forEach(th=>{
  th.addEventListener("click", ()=>{
    const key = th.getAttribute("data-key");
    if (sortKey === key) { sortDir = sortDir === "asc" ? "desc" : "asc"; }
    else { sortKey = key; el.sortKey.value = key; sortDir = "desc"; }
    el.sortDir.textContent = sortDir === "asc" ? "Asc" : "Desc";
    apply();
  });
});

/* More menu */
el.moreBtn.onclick = (e)=>{ e.stopPropagation(); el.moreMenu.classList.toggle("open"); };
document.addEventListener("click", ()=> el.moreMenu.classList.remove("open"));
el.dlCsv.onclick = downloadFilteredCSV;
el.copyLink.onclick = () => { navigator.clipboard.writeText(shareURL()); el.moreMenu.classList.remove("open"); el.moreBtn.textContent = "Copied!"; setTimeout(()=>el.moreBtn.textContent="More",900); };
el.resetAll.onclick = () => { resetAll(); el.moreMenu.classList.remove("open"); };

/* =================== Helpers =================== */
function setView(v){
  view = v;
  el.btnTable.classList.toggle("active", v==="table");
  el.btnCards.classList.toggle("active", v==="cards");
  el.viewTable.style.display = v==="table" ? "" : "none";
  el.viewCards.style.display = v==="cards" ? "" : "none";
}
function tokenMatch(hay, q){
  return q.split(/\s+/).every(t => hay.includes(t));
}
function apply(){
  page = 1;
  render();
  pushURL();
}
function pushURL(){
  const p = new URLSearchParams();
  if (el.q.value) p.set("q", el.q.value);
  if (el.cat.value) p.set("cat", el.cat.value);
  if (el.stat.value) p.set("stat", el.stat.value);
  if (el.from.value) p.set("from", el.from.value);
  if (el.to.value) p.set("to", el.to.value);
  if (sortKey!=="trend_score") p.set("sort", sortKey);
  if (sortDir!=="desc") p.set("dir", sortDir);
  if (view!=="table") p.set("view", view);
  if (page>1) p.set("page", page);
  if (perPage!==25) p.set("per", perPage);
  const url = location.pathname + "?" + p.toString();
  history.replaceState(null, "", url);
}
function shareURL(){ return location.href; }

/* =================== Filtering, Sorting, Rendering =================== */
function filterRows(){
  const q = el.q.value.trim().toLowerCase();
  const c = el.cat.value;
  const s = el.stat.value;
  const f = el.from.value;
  const t = el.to.value;

  rowsFiltered = rowsAll.filter(r=>{
    if (c && r.category!==c) return false;
    if (s && (r.status||"").toLowerCase()!==s) return false;
    if (f || t) { if (!rowInDateRangeMadrid(r.published, f, t)) return false; }
    if (q){
      const hay = (r.title+" "+(r.primary_keyword||"")+" "+(r.category||"")+" "+(r.status||"")).toLowerCase();
      if (!tokenMatch(hay, q)) return false;
    }
    return true;
  });
}
function sortRows(){
  const dir = sortDir==="asc" ? 1 : -1;
  rowsFiltered.sort((a,b)=>{
    let va, vb;
    if (sortKey==="trend_score"){ va = parseFloat(a.trend_score)||0; vb = parseFloat(b.trend_score)||0; }
    else if (sortKey==="published"){ va = Date.parse(a.published||0)||0; vb = Date.parse(b.published||0)||0; }
    else if (sortKey==="title"){ va = (a.title||"").toLowerCase(); vb = (b.title||"").toLowerCase(); }
    else { va = (a[sortKey]||""); vb = (b[sortKey]||""); }
    if (va<vb) return -1*dir; if (va>vb) return 1*dir; return 0;
  });
}
function renderCounts(){
  const total = rowsFiltered.length;
  const cats = ["fashion","beauty","wellness"].map(c=>`${c} ${rowsFiltered.filter(r=>r.category===c).length}`).join(" • ");
  const stats = ["emerging","bubbling","mainstream"].map(s=>`${s} ${rowsFiltered.filter(r=>(r.status||"").toLowerCase()===s).length}`).join(" • ");
  el.counts.textContent = `Showing ${total} • ${cats} • ${stats}`;
}
function renderTable(pageRows){
  el.tbody.innerHTML = pageRows.map(r=>{
    const when = fmtMadrid(r.published);
    const catCls = r.category ? `cat-${r.category}` : "";
    const statCls = r.status ? `stat-${(r.status||"").toLowerCase()}` : "";
    const catLink = r.category ? `?cat=${encodeURIComponent(r.category)}&view=${view}` : "#";
    const statLink = r.status ? `?stat=${encodeURIComponent((r.status||"").toLowerCase())}&view=${view}` : "#";
    return `<tr>
      <td>${when}</td>
      <td><a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title||"(untitled)")}</a></td>
      <td><span class="chip ${catCls}"><a href="${catLink}">${r.category||""}</a></span></td>
      <td><span class="chip">${escapeHtml(r.primary_keyword||"")}</span></td>
      <td>${(parseFloat(r.trend_score)||0).toFixed(2)}</td>
      <td><span class="chip ${statCls}"><a href="${statLink}">${(r.status||"")}</a></span></td>
    </tr>`;
  }).join("");
}
function renderCards(pageRows){
  el.cards.innerHTML = pageRows.map(r=>{
    const when = fmtMadrid(r.published);
    const catCls = r.category ? `cat-${r.category}` : "";
    const statCls = r.status ? `stat-${(r.status||"").toLowerCase()}` : "";
    const catLink = r.category ? `?cat=${encodeURIComponent(r.category)}&view=cards` : "#";
    const statLink = r.status ? `?stat=${encodeURIComponent((r.status||"").toLowerCase())}&view=cards` : "#";
    const score = (parseFloat(r.trend_score)||0).toFixed(2);
    return `<div class="card">
      <div class="muted">${when}</div>
      <h4><a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title||"(untitled)")}</a></h4>
      <div class="meta-line">
        <span class="chip ${catCls}"><a href="${catLink}">${r.category||""}</a></span>
        <span class="chip ${statCls}"><a href="${statLink}">${(r.status||"")}</a></span>
        ${r.primary_keyword? `<span class="chip">${escapeHtml(r.primary_keyword)}</span>`:""}
        <span class="chip">score ${score}</span>
      </div>
    </div>`;
  }).join("");
}
function render(){
  filterRows();
  sortRows();
  renderCounts();

  const maxp = Math.max(1, Math.ceil(rowsFiltered.length/perPage));
  if (page>maxp) page = maxp;
  const start = (page-1)*perPage;
  const pageRows = rowsFiltered.slice(start, start+perPage);

  if (view==="table"){
    renderTable(pageRows);
    el.pageInfo.textContent = pageInfoText(start, pageRows.length, rowsFiltered.length);
    el.pageInfoC.textContent = "";
  } else {
    renderCards(pageRows);
    el.pageInfoC.textContent = pageInfoText(start, pageRows.length, rowsFiltered.length);
    el.pageInfo.textContent = "";
  }

  // update header sort chevrons
  el.th.forEach(th=>{
    const k = th.getAttribute("data-key");
    const span = th.querySelector("span");
    if (!span) return;
    if (k===sortKey){ span.textContent = sortDir==="asc" ? "▲" : "▼"; }
    else { span.textContent = " "; }
  });
}
function pageInfoText(start, count, total){
  if (!total) return "No results";
  const a = start+1, b = start+count;
  return `Showing ${a}–${b} of ${total}`;
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }

/* =================== CSV & Boot =================== */
function loadCSV(){
  const bust = new Date().toISOString().slice(0,10);
  fetch('signals_simple.csv?ts='+bust)
    .then(r=>r.text())
    .then(txt=>Papa.parse(txt,{header:true,skipEmptyLines:true}))
    .then(res=>{
      rowsAll = res.data.map(r=>({
        published: r.published,
        title: r.title, link: r.link,
        category: (r.category||"").toLowerCase(),
        primary_keyword: r.primary_keyword,
        trend_score: r.trend_score,
        status: (r.status||"").toLowerCase()
      }));
      initFromQuery();
      render();
    })
    .catch(()=> alert('Could not load signals_simple.csv'));
}

/* =================== Download, Reset =================== */
function toCSV(rows){
  const header = ["published","title","link","category","primary_keyword","trend_score","status"];
  const lines = [header.join(",")].concat(rows.map(r => header.map(k => csvCell(r[k])).join(",")));
  return lines.join("\n");
}
function csvCell(v){
  if (v==null) return "";
  const s = String(v);
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function downloadFilteredCSV(){
  // ensure current filters applied
  filterRows(); sortRows();
  const blob = new Blob([toCSV(rowsFiltered)], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "signals_filtered.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function resetAll(){
  el.q.value = "";
  el.cat.value = "";
  el.stat.value = "";
  el.from.value = "";
  el.to.value = "";
  el.quick.value = "";
  el.sortKey.value = "trend_score";
  sortKey = "trend_score"; sortDir = "desc"; el.sortDir.textContent = "Desc";
  setView("table");
  page = 1; perPage = 25; el.rows.value="25"; el.rowsC.value="25";
  render(); pushURL();
}

/* =================== Kickoff =================== */
loadCSV();
</script>
