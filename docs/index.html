<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Signals</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#141414; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --accent:#111827;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --ctl-w:180px; --seg-w:160px;

    /* Category */
    --fashion-bg:#fff1f2; --fashion-bd:#fecdd3; --fashion-fg:#9f1239;
    --beauty-bg:#eef2ff;  --beauty-bd:#c7d2fe; --beauty-fg:#3730a3;
    --wellness-bg:#ecfeff;--wellness-bd:#a5f3fc;--wellness-fg:#155e75;

    /* Status */
    --emerg-bg:#ecfccb; --emerg-bd:#bef264; --emerg-fg:#3f6212;
    --bubbl-bg:#fef3c7; --bubbl-bd:#fcd34d; --bubbl-fg:#92400e;
    --main-bg:#f1f5f9;  --main-bd:#cbd5e1; --main-fg:#334155;
  }
  :root.dark{
    --bg:#0b0b0c; --fg:#f2f3f5; --muted:#a3a7ae;
    --card:#121317; --border:#2b2f36; --pill:#1b1f25; --accent:#e5e7eb;
    --shadow:0 10px 30px rgba(0,0,0,.35);

    --fashion-bg:#3b0b12; --fashion-bd:#701a29; --fashion-fg:#fecdd3;
    --beauty-bg:#1e1b4b;  --beauty-bd:#3730a3; --beauty-fg:#c7d2fe;
    --wellness-bg:#0b3a42;--wellness-bd:#0e7490;--wellness-fg:#a5f3fc;

    --emerg-bg:#1b2e0b; --emerg-bd:#3f6212; --emerg-fg:#bef264;
    --bubbl-bg:#3a2a0a; --bubbl-bd:#a16207; --bubbl-fg:#fcd34d;
    --main-bg:#0f172a;  --main-bd:#334155; --main-fg:#cbd5e1;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}

  /* Sticky toolbar */
  .bar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(180%) blur(10px);
    background:color-mix(in oklab, var(--bg) 90%, transparent); border-bottom:1px solid var(--border)}
  .bar-inner{max-width:1100px;margin:0 auto;padding:12px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .title{font-weight:700;font-size:18px}
  .spacer{flex:1}
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:var(--shadow)}
  .seg.fixed{width:var(--seg-w)} .seg.fixed button{flex:1 0 50%}
  .seg button{padding:8px 12px;border:0;background:var(--card);color:var(--fg);cursor:pointer}
  .seg button.active{background:var(--accent);color:var(--bg)}

  .btn{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .select,.input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);box-shadow:var(--shadow)}
  .select.fixed{width:var(--ctl-w)}
  .search{flex:1 1 320px;display:flex;gap:10px}
  .search input{width:100%}

  .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px;border:1px solid var(--border)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .chip{display:inline-flex;align-items:center;gap:6px} .chip button{all:unset;cursor:pointer;color:var(--muted)}

  /* Drawer */
  .drawer-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:80}
  .drawer{position:fixed;right:0;top:0;height:100%;width:360px;max-width:90vw;background:var(--bg);
    border-left:1px solid var(--border);box-shadow:var(--shadow);padding:18px;display:none;z-index:90}
  .drawer h3{margin:0 0 10px;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .drawer .actions{display:flex;gap:10px;margin-top:14px}

  /* Table */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;text-align:left}
  th{position:sticky;top:64px;background:var(--bg);z-index:1}
  th.sortable{cursor:pointer}
  th .arrow{opacity:.35;margin-left:6px}
  th.active .arrow{opacity:1}

  /* Cards — vertical with real covers */
  .cards{display:grid;gap:14px;margin-top:12px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
  .cover{width:100%;aspect-ratio:16/9;object-fit:cover;background:#f3f4f6}
  .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
  .card-title{display:block;font-weight:600;margin:0}
  .card-title a{color:inherit}
  .meta-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .meta-right{display:flex;align-items:center;gap:8px}
  .kchips{display:flex;gap:6px;flex-wrap:wrap}
  .kchip{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--border);color:var(--fg)}
  .footer{display:flex;align-items:center;justify-content:space-between;margin-top:2px}
  .muted{color:var(--muted)}
  .score{padding:2px 8px;border:1px solid var(--border);border-radius:999px}

  .tag{font-weight:600}
  .tag--fashion{background:var(--fashion-bg); border-color:var(--fashion-bd); color:var(--fashion-fg)}
  .tag--beauty{ background:var(--beauty-bg);  border-color:var(--beauty-bd);  color:var(--beauty-fg)}
  .tag--wellness{background:var(--wellness-bg);border-color:var(--wellness-bd);color:var(--wellness-fg)}
  .status{font-weight:600}
  .status--emerging{background:var(--emerg-bg);border-color:var(--emerg-bd);color:var(--emerg-fg)}
  .status--bubbling{background:var(--bubbl-bg);border-color:var(--bubbl-bd);color:var(--bubbl-fg)}
  .status--mainstream{background:var(--main-bg);border-color:var(--main-bd);color:var(--main-fg)}

  /* Pager */
  .pager{display:flex;align-items:center;justify-content:space-between;margin:16px 0;gap:12px;flex-wrap:wrap}
  .pager-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
</style>

<div class="bar" id="bar">
  <div class="bar-inner">
    <div class="title">The Futures Edit — Signals</div>
    <div class="search"><input id="q" class="input" type="search" placeholder="Search title / keyword / category / status… (Esc to clear)" /></div>
    <div class="seg fixed">
      <button id="viewTable" class="active" type="button">Table</button>
      <button id="viewCards" type="button">Cards</button>
    </div>
    <select id="sortKey" class="select fixed">
      <option value="trend_score" selected>Sort: Trend score</option>
      <option value="published">Sort: Published</option>
      <option value="title">Sort: Title</option>
      <option value="category">Sort: Category</option>
      <option value="primary_keyword">Sort: Keyword</option>
      <option value="status">Sort: Status</option>
    </select>
    <select id="barCat" class="select fixed">
      <option value="">All categories</option>
      <option>fashion</option><option>beauty</option><option>wellness</option>
    </select>
    <select id="barStatus" class="select fixed">
      <option value="">All status</option>
      <option>emerging</option><option>bubbling</option><option>mainstream</option>
    </select>
    <button id="filtersBtn" class="btn">Filters</button>
    <div class="spacer"></div>
    <div class="menu">
      <button class="btn" id="moreBtn" aria-haspopup="true" aria-expanded="false">More</button>
      <div class="menu-panel" id="moreMenu" role="menu" style="display:none">
        <a href="signals_simple.csv" download>Download CSV</a>
        <button id="copyFiltered">Copy filtered CSV</button>
        <button id="copyShare">Copy share link</button>
        <button id="resetAll">Reset all</button>
        <button id="darkToggle">Toggle dark mode</button>
        <a href="https://github.com/atelierfutures/futures-edit-signals" target="_blank" rel="noopener">Repository</a>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="chips" class="chips"></div>

  <!-- Table -->
  <table id="tbl">
    <thead>
      <tr>
        <th class="sortable" data-key="published">Published <span class="arrow">↕</span></th>
        <th class="sortable" data-key="title">Title <span class="arrow">↕</span></th>
        <th class="sortable" data-key="category" style="width:110px">Category <span class="arrow">↕</span></th>
        <th class="sortable" data-key="primary_keyword" style="width:180px">Keyword <span class="arrow">↕</span></th>
        <th class="sortable" data-key="trend_score" style="width:120px">Trend score <span class="arrow">↕</span></th>
        <th class="sortable" data-key="status" style="width:120px">Status <span class="arrow">↕</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Cards -->
  <div id="cards" class="cards" style="display:none"></div>

  <!-- Pager -->
  <div class="pager">
    <div class="pager-left muted" id="rangeInfo">Loading…</div>
    <div class="pager-right">
      <span>Rows per page:</span>
      <select id="pageSize" class="select fixed">
        <option selected>25</option><option>50</option><option>100</option><option>200</option>
      </select>
      <span id="pageInfo" class="muted">Page 1 of 1</span>
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="drawer-back" id="drawerBack"></div>
<div class="drawer" id="drawer" aria-modal="true" role="dialog">
  <h3>Filters & Dates</h3>
  <div class="grid">
    <label>Category
      <select id="cat" class="select">
        <option value="">All</option>
        <option>fashion</option><option>beauty</option><option>wellness</option>
      </select>
    </label>
    <label>Status
      <select id="stat" class="select">
        <option value="">All status</option>
        <option>emerging</option><option>bubbling</option><option>mainstream</option>
      </select>
    </label>
    <label>From <input id="from" type="date" class="input"></label>
    <label>To <input id="to" type="date" class="input"></label>
    <label style="grid-column:1 / -1">Quick
      <select id="quick" class="select" style="width:100%">
        <option value="">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
    </label>
  </div>
  <div class="actions">
    <button id="clearDates" class="btn" type="button">Clear dates</button>
    <button id="applyFilters" class="btn" type="button">Apply</button>
    <button id="closeDrawer" class="btn" type="button">Close</button>
  </div>
</div>

<script>
/* ---------- refs ---------- */
const bar = document.getElementById("bar");
const tbody   = document.querySelector("#tbl tbody");
const cardsEl = document.getElementById("cards");
const chipsEl = document.getElementById("chips");
const headers = [...document.querySelectorAll("th.sortable")];

const q = document.getElementById("q");
const sortKeySel = document.getElementById("sortKey");

const viewTableBtn = document.getElementById("viewTable");
const viewCardsBtn = document.getElementById("viewCards");

const barCatSel = document.getElementById("barCat");
const barStatusSel = document.getElementById("barStatus");

const pageSizeSel = document.getElementById("pageSize");
const prevBtn  = document.getElementById("prevBtn");
const nextBtn  = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");
const rangeInfo= document.getElementById("rangeInfo");

const drawerBack = document.getElementById("drawerBack");
const drawer = document.getElementById("drawer");
const filtersBtn = document.getElementById("filtersBtn");
const closeDrawer = document.getElementById("closeDrawer");
const applyFilters = document.getElementById("applyFilters");

const cat   = document.getElementById("cat");
const stat  = document.getElementById("stat");
const fromI = document.getElementById("from");
const toI   = document.getElementById("to");
const quick = document.getElementById("quick");
const clearDatesBtn = document.getElementById("clearDates");

const moreBtn  = document.getElementById("moreBtn");
const moreMenu = document.getElementById("moreMenu");
const copyFilteredBtn = document.getElementById("copyFiltered");
const copyShareBtn = document.getElementById("copyShare");
const resetAllBtn = document.getElementById("resetAll");
const darkToggleBtn = document.getElementById("darkToggle");

/* ---------- state ---------- */
let rowsAll = [];
let viewMode = "table";
let sortKey = "trend_score";
let sortDir = "desc";
let currentPage = 1;
let pageSize = parseInt(pageSizeSel.value,10) || 25;

const statusOrder = {emerging:0, bubbling:1, mainstream:2};
const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
const catClass = c => c && ["fashion","beauty","wellness"].includes(c) ? `pill tag tag--${c}` : "pill";
const statusClass = s => s ? `pill status status--${s.toLowerCase()}` : "pill";
const toDomain = url => { try { return new URL(url).hostname; } catch { return ""; } };

/* compact header */
window.addEventListener("scroll", ()=> bar.classList.toggle("compact", window.scrollY > 10));

/* theme */
(()=>{ const saved = localStorage.getItem("fe_theme"); if(saved==="dark") document.documentElement.classList.add("dark"); })();
darkToggleBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("fe_theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
};

/* sorting */
function updateSortUI(){
  sortKeySel.value = sortKey;
  headers.forEach(h=>{
    h.classList.toggle("active", h.dataset.key === sortKey);
    const arrow = h.querySelector(".arrow");
    if(arrow) arrow.textContent = h.dataset.key === sortKey ? (sortDir==="asc"?"↑":"↓") : "↕";
  });
}
function cmp(a,b,key){
  const dir = sortDir === "asc" ? 1 : -1;
  if(key === "trend_score"){
    const x = parseFloat(a.trend_score||0), y = parseFloat(b.trend_score||0);
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "published"){
    const x = Date.parse(a.published||"") || 0;
    const y = Date.parse(b.published||"") || 0;
    return (x<y?-1:x>y?1:0)*dir;
  }
  if(key === "status"){
    const x = statusOrder[(a.status||"").toLowerCase()] ?? 99;
    const y = statusOrder[(b.status||"").toLowerCase()] ?? 99;
    return (x<y?-1:x>y?1:0)*dir;
  }
  const x = (a[key]||"").toString().toLowerCase();
  const y = (b[key]||"").toString().toLowerCase();
  return (x<y?-1:x>y?1:0)*dir;
}
function setSort(key){
  if(sortKey === key){ sortDir = (sortDir === "asc") ? "desc" : "asc"; }
  else { sortKey = key; sortDir = (key === "trend_score" || key === "published") ? "desc" : "asc"; }
  currentPage = 1; updateSortUI(); render();
}
headers.forEach(h => h.addEventListener("click", () => setSort(h.dataset.key)));
sortKeySel.onchange = () => { sortKey = sortKeySel.value; sortDir = (sortKey==="trend_score"||sortKey==="published")?"desc":"asc"; currentPage=1; updateSortUI(); render(); };

/* view */
function setView(mode){
  viewMode = mode;
  viewTableBtn.classList.toggle("active", mode==="table");
  viewCardsBtn.classList.toggle("active", mode==="cards");
  document.getElementById("tbl").style.display = mode==="table" ? "" : "none";
  document.getElementById("cards").style.display = mode==="cards" ? "grid" : "none";
  currentPage = 1; render();
}
viewTableBtn.onclick  = () => setView("table");
viewCardsBtn.onclick  = () => setView("cards");

/* search */
const tokenize = s => (s||"").toLowerCase().trim().split(/\s+/).filter(Boolean);
function matches(row, query){
  const toks = tokenize(query);
  if(!toks.length) return true;
  const hay = [row.title||"", row.primary_keyword||"", row.category||"", (row.status||"").toLowerCase()].join(" ").toLowerCase();
  return toks.every(t => hay.includes(t));
}
function highlight(str, query){
  let out = str||"";
  tokenize(query).forEach(t=>{
    const re = new RegExp("(" + escRe(t) + ")", "ig");
    out = out.replace(re, "<mark>$1</mark>");
  });
  return out;
}
q.addEventListener("input", () => { currentPage=1; render(); });
window.addEventListener("keydown", e => {
  if(e.key === "Escape"){
    if(drawer.style.display==="block"){ closeDrawerFn(); }
    else { q.value=""; currentPage=1; render(); }
  }
});

/* toolbar filters */
barCatSel.onchange   = () => { cat.value = barCatSel.value; currentPage=1; render(); };
barStatusSel.onchange= () => { stat.value= barStatusSel.value; currentPage=1; render(); };

/* drawer */
function openDrawer(){ drawerBack.style.display="block"; drawer.style.display="block"; document.body.style.overflow="hidden"; }
function closeDrawerFn(){ drawerBack.style.display="none"; drawer.style.display="none"; document.body.style.overflow=""; }
filtersBtn.onclick = openDrawer;
closeDrawer.onclick = closeDrawerFn;
drawerBack.onclick  = closeDrawerFn;
applyFilters.onclick = () => {
  barCatSel.value = cat.value; barStatusSel.value = stat.value;
  currentPage=1; closeDrawerFn(); render();
};
clearDatesBtn.onclick = () => { fromI.value=""; toI.value=""; quick.value=""; };
quick.onchange = () => {
  const days = parseInt(quick.value) || 0;
  if(!days){ fromI.value=""; toI.value=""; return; }
  const today = new Date();
  const start = new Date(today.getTime() - days*86400000);
  fromI.value = start.toISOString().slice(0,10);
  toI.value   = today.toISOString().slice(0,10);
};

/* More menu */
function toggleMenu(open){ moreMenu.style.display = open ? "block" : "none"; moreBtn.setAttribute("aria-expanded", open ? "true" : "false"); }
moreBtn.onclick = (e)=>{ e.stopPropagation(); toggleMenu(getComputedStyle(moreMenu).display==="none"); };
document.addEventListener("click", (e)=>{ if(!moreMenu.contains(e.target) && e.target!==moreBtn) toggleMenu(false); });

/* reset / copy / share */
resetAllBtn.onclick = () => {
  q.value="";
  sortKey="trend_score"; sortDir="desc"; updateSortUI();
  cat.value=""; stat.value=""; barCatSel.value=""; barStatusSel.value="";
  fromI.value=""; toI.value=""; quick.value="";
  pageSizeSel.value="25"; pageSize=25; currentPage=1; setView("table"); toggleMenu(false); render();
};
copyFilteredBtn.onclick = async () => {
  const rows = getFilteredSortedRows();
  const header = ["published","title","link","category","primary_keyword","trend_score","status"];
  const csv = [header.join(",")].concat(rows.map(r => header.map(h => `"${(r[h]??"").toString().replace(/"/g,'""')}"`).join(","))).join("\n");
  try { await navigator.clipboard.writeText(csv);
    copyFilteredBtn.textContent = "Copied!"; setTimeout(()=> copyFilteredBtn.textContent="Copy filtered CSV", 1500);
  } catch {
    const blob = new Blob([csv], {type:"text/csv"}); const a = Object.assign(document.createElement("a"), {href:URL.createObjectURL(blob), download:"signals_filtered.csv"}); document.body.appendChild(a); a.click(); a.remove();
  }
};
copyShareBtn.onclick = async () => {
  const url = new URL(location.href); url.search = buildQuery().toString();
  try { await navigator.clipboard.writeText(url.toString());
    copyShareBtn.textContent = "Link copied!"; setTimeout(()=> copyShareBtn.textContent="Copy share link", 1500);
  } catch {}
};

/* pipeline */
function getFilteredSortedRows(){
  const query=q.value, c=barCatSel.value, s=barStatusSel.value;
  const fromMs = fromI.value ? new Date(new Date(fromI.value).setUTCHours(0,0,0,0)).getTime() : -Infinity;
  const toMs   = toI.value   ? new Date(new Date(toI.value).setUTCHours(23,59,59,999)).getTime() :  Infinity;

  let rows = rowsAll.filter(r => {
    if (c && r.category !== c) return false;
    if (s && (r.status||"").toLowerCase() !== s) return false;
    if (!matches(r, query)) return false;
    const pubMs = Date.parse(r.published || "");
    if (fromMs !== -Infinity || toMs !== Infinity){
      if (isNaN(pubMs)) return false;
      if (pubMs < fromMs || pubMs > toMs) return false;
    }
    return true;
  });

  rows = rows.sort((a,b)=>cmp(a,b,sortKey));
  return rows;
}

/* chips + url */
function renderChips(){
  const chips = [];
  if(q.value) chips.push({k:"search", label:`Search: ${q.value}`, clear:()=>{q.value="";}});
  if(barCatSel.value) chips.push({k:"category", label:`Category: ${barCatSel.value}`, clear:()=>{barCatSel.value=""; cat.value="";}});
  if(barStatusSel.value) chips.push({k:"status", label:`Status: ${barStatusSel.value}`, clear:()=>{barStatusSel.value=""; stat.value="";}});
  if(fromI.value || toI.value) chips.push({k:"dates", label:`Date: ${fromI.value||"…"} → ${toI.value||"…"}`, clear:()=>{fromI.value=""; toI.value=""; quick.value="";}});
  chipsEl.innerHTML = chips.map(c => `<span class="pill chip">${c.label} <button title="clear" data-k="${c.k}">×</button></span>`).join("");
  chipsEl.querySelectorAll("button").forEach(b=>{
    b.onclick = () => { const k=b.dataset.k; const c = chips.find(x=>x.k===k); if(c){c.clear(); currentPage=1; render();} };
  });
}
function buildQuery(){
  const p = new URLSearchParams();
  if(q.value) p.set("q", q.value);
  if(barCatSel.value) p.set("cat", barCatSel.value);
  if(barStatusSel.value) p.set("stat", barStatusSel.value);
  if(fromI.value) p.set("from", fromI.value);
  if(toI.value) p.set("to", toI.value);
  if(viewMode!=="table") p.set("view", viewMode);
  if(sortKey!=="trend_score") p.set("sort", sortKey);
  if(sortDir!=="desc") p.set("dir", sortDir);
  if(pageSize!==25) p.set("size", String(pageSize));
  if(currentPage!==1) p.set("page", String(currentPage));
  return p;
}
function syncUrl(){ history.replaceState(null, "", "?"+buildQuery().toString()); }

/* ---------- Better cover detection ---------- */
/* We parse meta (og/twitter) and JSON-LD. We skip logos/icons/defaults. */
const badImgHints = /(logo|icon|sprite|brand|placeholder|default|opengraph|ogimage)/i;
const goodExt = /\.(jpe?g|png|webp|avif)(\?|#|$)/i;

function absUrl(u, base){ try { return new URL(u, base).toString(); } catch { return u; } }

function jsonLdImages(html, base){
  const out = [];
  const scripts = [...html.matchAll(/<script[^>]+type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi)];
  for(const m of scripts){
    let txt = m[1].trim();
    // attempt to parse safely
    try{
      const data = JSON.parse(txt);
      const items = Array.isArray(data) ? data : [data];
      for(const it of items){
        const img = it && it.image;
        if(!img) continue;
        if(typeof img === "string") out.push(absUrl(img, base));
        else if(Array.isArray(img)) img.forEach(x=>{
          if(typeof x === "string") out.push(absUrl(x, base));
          else if(x && x.url) out.push(absUrl(x.url, base));
        });
        else if(img && img.url) out.push(absUrl(img.url, base));
      }
    }catch{ /* ignore */ }
  }
  return out;
}

function metaImages(html, base){
  const out = [];
  const add = (re) => { for(const m of html.matchAll(re)) out.push(absUrl(m[1], base)); };
  add(/<meta[^>]+property=["']og:image(?::secure_url|:url)?["'][^>]+content=["']([^"']+)["']/gi);
  add(/<meta[^>]+name=["']twitter:image(?::src)?["'][^>]+content=["']([^"']+)["']/gi);
  return out;
}

async function findCover(link){
  const proxied = "https://r.jina.ai/http://" + link.replace(/^https?:\/\//,'');
  try{
    const html = await fetch(proxied, {mode:"cors"}).then(r=>r.text());
    const base = link;
    let candidates = [
      ...jsonLdImages(html, base),
      ...metaImages(html, base),
    ];
    // de-dupe
    candidates = [...new Set(candidates)];
    // prefer non-logo looking and with good image extensions
    const scored = candidates.map(u => {
      const bad = badImgHints.test(u) ? 1 : 0;
      const ext = goodExt.test(u) ? 0 : 1;
      // shorter is often logo; give penalty to very short paths
      let pathLen = 0; try { pathLen = new URL(u).pathname.length; } catch {}
      const shortPenalty = pathLen < 20 ? 1 : 0;
      return {u, score: bad + ext + shortPenalty};
    }).sort((a,b)=> a.score - b.score);
    const pick = scored.length ? scored[0].u : null;
    return pick;
  }catch{ return null; }
}

function faviconFor(link){ const d = toDomain(link); return d ? `https://www.google.com/s2/favicons?domain=${d}&sz=128` : ""; }

function applyCovers(){
  const cards = cardsEl.querySelectorAll('.card[data-link]');
  cards.forEach(async card=>{
    const img = card.querySelector('img.cover');
    if(img.dataset.done) return;
    img.dataset.done = "1";
    img.loading = "lazy";
    img.alt = "preview";
    img.referrerPolicy = "no-referrer";
    const link = card.dataset.link;
    let src = await findCover(link);
    if(!src) src = faviconFor(link);
    if(!src) { img.style.background = '#e5e7eb'; return; }
    img.src = src;
  });
}

/* ---------- render ---------- */
function render(){
  const rows = getFilteredSortedRows();
  const total = rows.length;

  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1) * pageSize;
  const end   = Math.min(start + pageSize, total);
  const slice = rows.slice(start, end);

  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  rangeInfo.textContent = `Showing ${start+1}-${end} of ${total}`;

  if(viewMode==="table"){
    tbody.innerHTML = slice.map(r => `
      <tr>
        <td>${(r.published||"").slice(0,10)}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></td>
        <td><span class="${catClass(r.category)}">${r.category||""}</span></td>
        <td>${highlight(r.primary_keyword||"", q.value)}</td>
        <td>${r.trend_score ?? ""}</td>
        <td><span class="${statusClass(r.status||"")}">${(r.status||"").toLowerCase()}</span></td>
      </tr>
    `).join("");
  } else {
    cardsEl.innerHTML = slice.map(r => {
      // keywords neat: up to 3 chips + +N
      const allK = (r.primary_keyword||"")
        .split(",").map(s=>s.trim()).filter(Boolean);
      const shown = allK.slice(0,3);
      const moreN = Math.max(0, allK.length - shown.length);
      const chips = shown.map(k=>`<span class="kchip">${highlight(k, q.value)}</span>`).join("")
                    + (moreN ? `<span class="kchip">+${moreN}</span>` : "");
      return `
        <div class="card" data-link="${r.link}">
          <img class="cover" alt="">
          <div class="card-body">
            <div class="card-title"><a href="${r.link}" target="_blank" rel="noopener">${highlight(r.title, q.value)}</a></div>
            <div class="meta-row">
              <span class="${catClass(r.category)}">${r.category||""}</span>
              <div class="meta-right">
                <span class="${statusClass(r.status||"")}">${(r.status||"").toLowerCase()}</span>
                <span class="score">score ${r.trend_score ?? ""}</span>
              </div>
            </div>
            ${chips ? `<div class="kchips">${chips}</div>` : ""}
            <div class="footer">
              <span class="muted">${(r.published||"").slice(0,10)}</span>
              <span></span>
            </div>
          </div>
        </div>
      `;
    }).join("");
    applyCovers();
  }

  renderChips();
  syncUrl();
}

/* paging */
pageSizeSel.onchange = () => { pageSize = parseInt(pageSizeSel.value,10) || 25; currentPage=1; render(); };
prevBtn.onclick = () => { if(currentPage>1){ currentPage--; render(); } };
nextBtn.onclick = () => { currentPage++; render(); };

/* restore + load */
function restoreFromUrl(){
  const p = new URLSearchParams(location.search);
  if(p.get("q")) q.value = p.get("q");
  if(p.get("cat")) { barCatSel.value = p.get("cat"); cat.value = barCatSel.value; }
  if(p.get("stat")){ barStatusSel.value = p.get("stat"); stat.value = barStatusSel.value; }
  if(p.get("from")) fromI.value = p.get("from");
  if(p.get("to")) toI.value = p.get("to");
  const v = p.get("view"); if(v==="cards") setView("cards"); else setView("table");
  const sk = p.get("sort"); if(sk){ sortKey = sk; }
  const sd = p.get("dir"); if(sd){ sortDir = sd; }
  const ps = parseInt(p.get("size")||"25",10); pageSize = ps; pageSizeSel.value = String(ps);
  const pg = parseInt(p.get("page")||"1",10); currentPage = Math.max(1, pg);
  updateSortUI();
}
function load(){
  restoreFromUrl();
  const bust = new Date().toISOString().slice(0,10);
  fetch("signals_simple.csv?ts="+bust)
    .then(r => r.text())
    .then(csv => Papa.parse(csv, {header:true, skipEmptyLines:true}))
    .then(res => { rowsAll = res.data; render(); })
    .catch(() => { rangeInfo.textContent = "Failed to load CSV"; });
}
load();
</script>
