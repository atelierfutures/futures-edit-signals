<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Tags & Trend Score</title>

<!-- Libraries -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#141414; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --accent:#111827;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --bar-h:84px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);
         height:var(--bar-h);display:flex;align-items:center;gap:12px;padding:0 18px;z-index:10}
  h1{margin:0;font-weight:700;font-size:18px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.3rem .55rem;border-radius:999px;
        background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827}
  main{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  h2{margin:0 0 8px 0;font:600 18px/1.2 inherit}
  small,.muted{color:var(--muted)}
  .chart-wrap{height:340px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:left}
  thead th{background:#f9fafb;border-bottom:1px solid var(--border)}
  details summary{cursor:pointer}
</style>

<header>
  <h1>The Futures Edit — Tags & Trend Score</h1>
  <span class="pill" id="dataset-meta">loading…</span>
</header>

<main>
  <!-- Trend Score -->
  <section class="card" id="trend-score">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Trend Score — Top 15</h2>
      <small id="trend-sample-meta" class="muted"></small>
    </div>
    <div class="chart-wrap"><canvas id="trendScoreChart"></canvas></div>

    <details style="margin-top:12px;">
      <summary><strong>How we calculate Trend Score</strong></summary>
      <div class="muted" style="margin-top:8px;">
        <p style="margin:0 0 6px 0;"><strong>Formula:</strong></p>
        <pre style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;margin:0 0 10px 0;font-size:13px;">
TrendScore = 0.40 × Volumeₙ + 0.40 × Growthₙ + 0.20 × Recencyₙ
        </pre>
        <ul style="margin:0 0 10px 18px;padding:0;">
          <li><strong>Volumeₙ</strong>: min–max normalized 0–100 from the <em>volume</em> column.</li>
          <li><strong>Growthₙ</strong>: min–max normalized 0–100 from <em>growth_rate</em> (negatives clipped at 0).</li>
          <li><strong>Recencyₙ</strong>: 0–100 from <em>last_seen</em>. 100 = today; 0 = ≥90 days ago; linear in between.</li>
        </ul>
        <p style="margin:0;">We scale each component to 0–100, apply the weights above, then round.</p>
      </div>
    </details>

    <div id="trend-table" style="margin-top:14px;overflow:auto;"></div>
    <div id="trend-errors" style="margin-top:10px;color:#b91c1c;"></div>
  </section>

  <!-- Tags Overview -->
  <section class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Top Tags</h2>
      <small class="muted" id="tags-meta"></small>
    </div>
    <div class="chart-wrap"><canvas id="tagsBarChart"></canvas></div>
    <div id="tags-cloud" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;"></div>
  </section>
</main>

<!-- Embedded fallback data (used only if data/signals.csv is missing) -->
<script type="text/csv" id="embedded-signals">
keyword,volume,growth_rate,last_seen,tags
"glazed blush",78,22,"2025-09-12","beauty, makeup"
"vanilla girl",40,5,"2025-08-28","fashion, lifestyle"
"quiet luxury",95,-8,"2025-07-05","fashion"
"skin cycling",60,18,"2025-09-10","beauty, skincare"
"blue beauty",30,35,"2025-08-31","beauty, sustainability"
"olfactory branding",22,41,"2025-09-09","retail, experience"
"biodegradable glitter",18,55,"2025-09-13","beauty, materials"
"spa water 2.0",15,8,"2025-08-22","wellness, drinks"
"augmented try-on",55,27,"2025-09-11","beauty, tech"
"fermented skincare",28,12,"2025-08-30","beauty, skincare"
"regenerative cotton",20,33,"2025-09-01","fashion, sustainability"
"scalp care",42,9,"2025-09-07","beauty, hair"
"refillable packaging",36,14,"2025-09-06","beauty, packaging"
"circadian lighting",25,31,"2025-09-02","home, wellness"
"athleisure tailoring",32,6,"2025-08-29","fashion"
</script>

<script>
/* ===========================
   BASIC CONFIG (no coding needed)
   ===========================
   - If you have a real CSV, put it at: data/signals.csv
     Columns expected: keyword, volume, growth_rate, last_seen, tags
   - This page will try to load it. If it can't, it will use the embedded sample above.
*/
const CSV_URL = 'data/signals.csv'; // keep as is unless your path is different

// ---------- Utils ----------
const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
function minmaxNormalize(values) {
  const arr = values.map(v => (isFinite(+v) ? +v : 0));
  const min = Math.min(...arr), max = Math.max(...arr);
  if (!isFinite(min) || !isFinite(max) || max === min) return arr.map(_ => 0);
  return arr.map(v => ((v - min) / (max - min)) * 100);
}
function recencyScoreFromDateStr(dateStr) {
  const now = new Date();
  const d = new Date(dateStr);
  if (isNaN(d)) return 0;
  const days = (now - d) / (1000*60*60*24);
  const score = 100 - (days / 90) * 100; // 0d → 100, ≥90d → 0
  return clamp(score, 0, 100);
}
function showError(msg){
  const e = document.getElementById('trend-errors');
  if (e) e.textContent = msg;
  console.error('[tags.html]', msg);
}
function makeBar(canvasId, labels, data, label) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (window[canvasId]) window[canvasId].destroy?.();
  window[canvasId] = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label, data, borderWidth: 1 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
}

// ---------- Data loading with graceful fallback ----------
async function loadSignals() {
  // Try external CSV first
  try {
    const parsed = await new Promise((res, rej) => {
      Papa.parse(CSV_URL, { download:true, header:true, dynamicTyping:true, complete:res, error:rej });
    });
    const rows = (parsed?.data || []).filter(r => r && Object.keys(r).length);
    if (rows.length) return { rows, source: 'csv' };
  } catch (err) {
    // ignore, we'll fallback
  }
  // Fallback to embedded CSV
  const embedded = document.getElementById('embedded-signals')?.textContent?.trim();
  if (!embedded) { showError('No data available (CSV missing and no embedded sample).'); return { rows: [], source: 'none' }; }
  const parsed2 = Papa.parse(embedded, { header:true, dynamicTyping:true });
  const rows = (parsed2?.data || []).filter(r => r && Object.keys(r).length);
  return { rows, source: 'embedded' };
}

// ---------- Main render ----------
(async function () {
  const { rows, source } = await loadSignals();

  const datasetMeta = document.getElementById('dataset-meta');
  datasetMeta.textContent = rows.length
    ? `${rows.length} rows • ${new Date().toISOString().slice(0,10)} • ${source === 'csv' ? 'CSV' : 'sample'}`
    : '0 rows';

  if (!rows.length) return;

  // Map columns
  const get = (r, k) => r[k] ?? r[k?.toLowerCase?.()] ?? r[k?.toUpperCase?.()];
  const keywords = rows.map(r => String(get(r,'keyword') ?? '').trim() || '(untitled)');
  const volumes  = rows.map(r => Number.isFinite(+get(r,'volume')) ? +get(r,'volume') : 0);
  const growths0 = rows.map(r => Number.isFinite(+get(r,'growth_rate')) ? +get(r,'growth_rate') : 0);
  const growths  = growths0.map(v => Math.max(0, v)); // negatives clipped at 0 for score
  const recency  = rows.map(r => recencyScoreFromDateStr(get(r,'last_seen')));

  // Normalize & score
  const volN = minmaxNormalize(volumes);
  const groN = minmaxNormalize(growths);
  const recN = recency;
  const scores = volN.map((_, i) => Math.round(0.40*volN[i] + 0.40*groN[i] + 0.20*recN[i]));

  // Rank Top 15
  const ranked = keywords.map((k,i) => ({
    keyword:k, score:scores[i],
    volN:Math.round(volN[i]), groN:Math.round(groN[i]), recN:Math.round(recN[i])
  })).sort((a,b) => b.score - a.score);

  const top = ranked.slice(0, 15);
  makeBar('trendScoreChart', top.map(d => d.keyword), top.map(d => d.score), 'Trend Score (0–100)');
  document.getElementById('trend-sample-meta').textContent = `(Top ${top.length} of ${rows.length} signals)`;

  // Table
  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr>
      <th>#</th><th>Signal</th><th>Score</th>
      <th>Volumeₙ</th><th>Growthₙ</th><th>Recencyₙ</th>
    </tr></thead><tbody></tbody>`;
  top.forEach((d,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${d.keyword}</td>
      <td style="font-weight:600">${d.score}</td>
      <td class="muted">${d.volN}</td>
      <td class="muted">${d.groN}</td>
      <td class="muted">${d.recN}</td>`;
    tbl.querySelector('tbody').appendChild(tr);
  });
  document.getElementById('trend-table').appendChild(tbl);

  // Tags overview
  const tagCounts = new Map();
  rows.forEach(r => {
    const raw = get(r,'tags');
    if (!raw) return;
    String(raw).split(',').map(s => s.trim()).filter(Boolean).forEach(t => {
      tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
    });
  });
  const tagsSorted = Array.from(tagCounts.entries()).sort((a,b) => b[1]-a[1]).slice(0,25);
  document.getElementById('tags-meta').textContent = tagsSorted.length ? `(Top ${tagsSorted.length})` : '(no tags found)';

  if (tagsSorted.length){
    makeBar('tagsBarChart', tagsSorted.map(([t])=>t), tagsSorted.map(([,c])=>c), 'Count');
    const cloud = document.getElementById('tags-cloud');
    tagsSorted.forEach(([t,c]) => {
      const span = document.createElement('span');
      span.className = 'pill';
      span.textContent = `${t} • ${c}`;
      cloud.appendChild(span);
    });
  }
})();
</script>
