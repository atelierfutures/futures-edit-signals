<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Tags & Graphs</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#141414; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --accent:#111827;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --bar-h: 80px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);height:var(--bar-h);display:flex;align-items:center;gap:16px;padding:0 20px;z-index:10}
  h1{margin:0;font-weight:700;font-size:18px}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width: 980px){ .row{grid-template-columns:1fr 1fr} }
  h2{margin:0 0 8px 0;font:600 18px/1.2 inherit}
  small, .muted{color:var(--muted)}
  .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:left}
  thead th{background:#f9fafb;border-bottom:1px solid var(--border)}
  details summary{cursor:pointer}
  .chart-wrap{height:320px}
</style>

<header>
  <h1>The Futures Edit — Signals: Tags & Graphs</h1>
  <span class="pill" id="dataset-meta"></span>
</header>

<main>
  <!-- Trend Score -->
  <section class="card" id="trend-score">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Trend Score — Top 15</h2>
      <small id="trend-sample-meta" class="muted"></small>
    </div>
    <div class="chart-wrap"><canvas id="trendScoreChart"></canvas></div>

    <details style="margin-top:12px;">
      <summary><strong>How we calculate Trend Score</strong></summary>
      <div class="muted" style="margin-top:8px;">
        <p style="margin:0 0 6px 0;"><strong>Formula:</strong></p>
        <pre style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;margin:0 0 10px 0;font-size:13px;">
TrendScore = 0.40 × Volumeₙ + 0.40 × Growthₙ + 0.20 × Recencyₙ
        </pre>
        <ul style="margin:0 0 10px 18px;padding:0;">
          <li><strong>Volumeₙ</strong>: min–max normalized 0–100 from the <em>volume</em> column.</li>
          <li><strong>Growthₙ</strong>: min–max normalized 0–100 from <em>growth_rate</em> (negatives clipped at 0).</li>
          <li><strong>Recencyₙ</strong>: 0–100 from <em>last_seen</em>. 100 = today; 0 = ≥90 days ago; linear in between.</li>
        </ul>
        <p style="margin:0;">We scale each component to 0–100, apply the weights above, then round.</p>
      </div>
    </details>

    <div id="trend-table" style="margin-top:14px;overflow:auto;"></div>
  </section>

  <!-- Tags Overview (optional – tweak to your schema) -->
  <section class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Top Tags</h2>
      <small class="muted" id="tags-meta"></small>
    </div>
    <div class="chart-wrap"><canvas id="tagsBarChart"></canvas></div>
    <div id="tags-cloud" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;"></div>
  </section>
</main>

<script>
(async function () {
  // ─────────────────────────────────────────────────────────────
  // 1) CONFIG — point to your CSV and column names
  // ─────────────────────────────────────────────────────────────
  const CSV_URL = 'data/signals.csv'; // ← change to your path
  const COLS = {
    keyword:  'keyword',      // string
    volume:   'volume',       // numeric
    growth:   'growth_rate',  // numeric (% WoW/MoM). Negatives allowed; we clip to 0 for score.
    lastSeen: 'last_seen',    // date string (ISO best)
    tags:     'tags'          // optional: comma-separated list, e.g. "beauty, packaging, retail"
  };

  // ─────────────────────────────────────────────────────────────
  // 2) Helpers
  // ─────────────────────────────────────────────────────────────
  const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
  function minmaxNormalize(values) {
    const arr = values.map(v => (isFinite(+v) ? +v : 0));
    const min = Math.min(...arr), max = Math.max(...arr);
    if (!isFinite(min) || !isFinite(max) || max === min) return arr.map(_ => 0);
    return arr.map(v => ((v - min) / (max - min)) * 100);
  }
  function recencyScoreFromDateStr(dateStr) {
    const now = new Date();
    const d = new Date(dateStr);
    if (isNaN(d)) return 0;
    const days = (now - d) / (1000*60*60*24);
    const score = 100 - (days / 90) * 100; // 0d → 100, 90d+ → 0
    return clamp(score, 0, 100);
  }
  function makeBar(el, labels, data, label) {
    const ctx = document.getElementById(el).getContext('2d');
    if (window[el]) window[el].destroy?.();
    window[el] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label, data, borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // ─────────────────────────────────────────────────────────────
  // 3) Load CSV
  // ─────────────────────────────────────────────────────────────
  const parsed = await new Promise((res, rej) => {
    Papa.parse(CSV_URL, { download:true, header:true, dynamicTyping:true, complete:res, error:rej });
  });
  const rows = (parsed?.data || []).filter(r => r && Object.keys(r).length);
  document.getElementById('dataset-meta').textContent = `${rows.length} rows • ${new Date().toISOString().slice(0,10)}`;

  // ─────────────────────────────────────────────────────────────
  // 4) Trend Score calculation
  // ─────────────────────────────────────────────────────────────
  const keywords = rows.map(r => String(r[COLS.keyword] ?? '').trim() || '(untitled)');
  const volumes  = rows.map(r => Number.isFinite(+r[COLS.volume]) ? +r[COLS.volume] : 0);
  const growths  = rows.map(r => Math.max(0, Number.isFinite(+r[COLS.growth]) ? +r[COLS.growth] : 0)); // clip <0 to 0
  const recency  = rows.map(r => recencyScoreFromDateStr(r[COLS.lastSeen]));

  const volN = minmaxNormalize(volumes);
  const groN = minmaxNormalize(growths);
  const recN = recency;

  const scores = volN.map((_, i) => Math.round(0.40*volN[i] + 0.40*groN[i] + 0.20*recN[i]));

  let indexed = keywords.map((k,i) => ({
    keyword:k, score:scores[i],
    volN:Math.round(volN[i]), groN:Math.round(groN[i]), recN:Math.round(recN[i])
  })).sort((a,b) => b.score - a.score);

  const top = indexed.slice(0, 15);
  makeBar('trendScoreChart', top.map(d => d.keyword), top.map(d => d.score), 'Trend Score (0–100)');
  document.getElementById('trend-sample-meta').textContent = `(Top 15 of ${rows.length} signals)`;

  // Table
  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr>
      <th>#</th><th>Signal</th><th>Score</th>
      <th>Volumeₙ</th><th>Growthₙ</th><th>Recencyₙ</th>
    </tr></thead><tbody></tbody>`;
  top.forEach((d,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${d.keyword}</td>
      <td style="font-weight:600">${d.score}</td>
      <td class="muted">${d.volN}</td>
      <td class="muted">${d.groN}</td>
      <td class="muted">${d.recN}</td>`;
    tbl.querySelector('tbody').appendChild(tr);
  });
  document.getElementById('trend-table').appendChild(tbl);

  // ─────────────────────────────────────────────────────────────
  // 5) Tags overview (optional)
  // ─────────────────────────────────────────────────────────────
  const tagCounts = new Map();
  rows.forEach(r => {
    const raw = r[COLS.tags];
    if (!raw) return;
    String(raw).split(',').map(s => s.trim()).filter(Boolean).forEach(t => {
      tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
    });
  });
  const tagsSorted = Array.from(tagCounts.entries()).sort((a,b) => b[1]-a[1]).slice(0,25);
  document.getElementById('tags-meta').textContent = tagsSorted.length ? `(Top ${tagsSorted.length})` : '(no tags found)';

  if (tagsSorted.length){
    makeBar('tagsBarChart', tagsSorted.map(([t])=>t), tagsSorted.map(([,c])=>c), 'Count');
    const cloud = document.getElementById('tags-cloud');
    tagsSorted.forEach(([t,c]) => {
      const span = document.createElement('span');
      span.className = 'pill';
      span.textContent = `${t} • ${c}`;
      cloud.appendChild(span);
    });
  }
})();
</script>
