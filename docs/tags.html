<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit — Tags, Trends & Signals</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{ --bg:#fff; --fg:#141414; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --pill:#f3f4f6; --shadow:0 8px 24px rgba(0,0,0,.06); --bar-h:84px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);height:var(--bar-h);display:flex;align-items:center;gap:12px;padding:0 18px;z-index:10}
  h1{margin:0;font-weight:700;font-size:18px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.3rem .55rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827}
  main{max-width:1200px;margin:22px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:1100px){ .grid-2{grid-template-columns:1.4fr .9fr} .grid-2-even{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  h2{margin:0 0 8px 0;font:600 18px/1.2 inherit}
  h3{margin:0 0 6px 0;font:600 15px/1.2 inherit}
  small,.muted{color:var(--muted)}
  .chart-wrap{height:340px}
  .chart-wrap-sm{height:280px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:left;vertical-align:top}
  thead th{background:#f9fafb;border-bottom:1px solid var(--border)}
  details summary{cursor:pointer}
  .tags-cloud{display:flex;flex-wrap:wrap;gap:8px}
  .tag-pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:.45rem .7rem;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin:10px 0}
  .kpi .box{border:1px solid var(--border);border-radius:12px;padding:10px}
  .kpi .box b{font-size:18px}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .select{border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#fff}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .why{font-size:12px;color:#4b5563}
  .linkline a{font-weight:600;text-decoration:none;color:#111827}
  .linkline small{color:var(--muted)}
</style>

<header>
  <h1>The Futures Edit — Tags, Trends & Signals</h1>
  <span class="pill" id="dataset-meta">loading…</span>
</header>

<main class="grid">
  <!-- 1) Momentum Score — Breakouts -->
  <section class="card" id="sec-momentum">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Momentum Score — Breakouts (Top 15)</h2>
      <small id="momentum-meta" class="muted"></small>
    </div>
    <div class="chart-wrap"><canvas id="momentumChart"></canvas></div>
    <details style="margin-top:12px;">
      <summary><strong>How we calculate Momentum Score</strong></summary>
      <div class="muted" style="margin-top:8px;">
        <pre style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;margin:0 0 10px 0;font-size:13px;">
Momentum = 0.55 × Growthₙ + 0.35 × Recencyₙ + 0.10 × Noveltyₙ
Noveltyₙ = 100 − Volumeₙ
        </pre>
        <p style="margin:0;">Momentum spots <strong>emerging / breaking</strong> signals; Trend Score shows overall <strong>heat</strong>.</p>
      </div>
    </details>
  </section>

  <!-- 2) SIGNALS — Top 25 + insights -->
  <section class="grid grid-2 card" style="display:grid;gap:16px;">
    <div>
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0">Signals — Top 25</h2>
        <div class="row">
          <label for="rank-by" class="muted" style="align-self:center;">Rank by</label>
          <select id="rank-by" class="select">
            <option value="trend" selected>Trend Score</option>
            <option value="momentum">Momentum Score</option>
            <option value="volume">Volume</option>
            <option value="growth">Growth %</option>
          </select>
        </div>
      </div>
      <div id="signals-meta" class="muted" style="margin-bottom:6px;"></div>
      <div class="chart-wrap"><canvas id="signalsChart"></canvas></div>
      <small class="muted" style="display:block;margin-top:6px;">Click a bar to analyze the signal on the right.</small>

      <details style="margin-top:12px;">
        <summary><strong>Trend Score (reference)</strong></summary>
        <div class="muted" style="margin-top:8px;">
          <pre style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;margin:0 0 10px 0;font-size:13px;">
Trend = 0.40 × Volumeₙ + 0.40 × Growthₙ + 0.20 × Recencyₙ
          </pre>
        </div>
      </details>
    </div>

    <aside>
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0">Signal Insights</h2>
        <button id="copy-summary" class="btn" title="Copy a short summary to clipboard">Copy summary</button>
      </div>
      <div id="signal-title" style="font:700 18px/1.2 ui-sans-serif,system-ui;">Select a signal →</div>
      <div class="muted" id="signal-tags" style="margin-top:6px;"></div>

      <div class="kpi">
        <div class="box"><div class="muted">Trend Score</div><b id="kpi-score">–</b></div>
        <div class="box"><div class="muted">Momentum</div><b id="kpi-momentum">–</b></div>
        <div class="box"><div class="muted">Volume</div><b id="kpi-volume">–</b></div>
        <div class="box"><div class="muted">Growth %</div><b id="kpi-growth">–</b></div>
        <div class="box"><div class="muted">Last seen</div><b id="kpi-lastseen">–</b></div>
      </div>

      <div class="divider"></div>
      <h3>Related Articles</h3>
      <div class="row" style="gap:8px;margin-bottom:6px;">
        <button id="open-top5" class="btn">Open top 5</button>
        <button id="copy-citations" class="btn">Copy citations</button>
      </div>
      <div id="articles-count" class="muted" style="margin-bottom:4px;"></div>
      <div id="articles-list" class="muted">No signal selected.</div>
      <div id="articles-more" style="margin-top:6px;display:none;">
        <button id="btn-show-more" class="btn">Show more</button>
        <button id="btn-show-less" class="btn" style="display:none;">Show less</button>
      </div>

      <div class="divider"></div>
      <h3>Content Kit (simple)</h3>
      <div class="row">
        <button id="gen-kit" class="btn">Generate kit</button>
        <button id="copy-kit" class="btn">Copy all</button>
      </div>

      <div id="kit-out" class="card" style="display:none;margin-top:10px;padding:12px;">
        <h4 style="margin:0 0 6px 0;">Executive takeaway</h4>
        <pre id="kit-takeaway" style="white-space:pre-wrap;margin:0 0 8px 0;"></pre>
        <h4 style="margin:10px 0 6px 0;">Newsletter blurb</h4>
        <pre id="kit-news" style="white-space:pre-wrap;margin:0 0 8px 0;"></pre>
        <h4 style="margin:10px 0 6px 0;">LinkedIn post</h4>
        <pre id="kit-li" style="white-space:pre-wrap;margin:0 0 8px 0;"></pre>
        <h4 style="margin:10px 0 6px 0;">Social hooks (3)</h4>
        <pre id="kit-hooks" style="white-space:pre-wrap;margin:0 0 8px 0;"></pre>
        <h4 style="margin:10px 0 6px 0;">KPIs to track (3)</h4>
        <pre id="kit-kpis" style="white-space:pre-wrap;margin:0;"></pre>
      </div>
    </aside>
  </section>

  <!-- 3) Opportunity — What to cover now -->
  <section class="card">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Opportunity — What to cover now (Top 12)</h2>
      <small id="opp-meta" class="muted"></small>
    </div>
    <div class="chart-wrap-sm"><canvas id="oppChart"></canvas></div>

    <details style="margin-top:12px;">
      <summary><strong>How we calculate Opportunity</strong></summary>
      <div class="muted" style="margin-top:8px;">
        <pre style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;margin:0 0 10px 0;font-size:13px;">
Opp = 0.55 × Momentum + 0.30 × (100 − Saturationₙ) + 0.15 × CrossIndustryₙ
Saturationₙ = min–max normalized article_count per signal (more coverage = higher saturation)
CrossIndustryₙ = (# of verticals among {Fashion, Beauty, Wellness} / 3) × 100
        </pre>
      </div>
    </details>

    <div id="opp-table" style="margin-top:12px;overflow:auto;"></div>
  </section>

  <!-- 4) Top Tags -->
  <section class="card">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Top Tags</h2>
      <small class="muted" id="tags-meta"></small>
    </div>
    <div class="chart-wrap-sm"><canvas id="tagsBarChart"></canvas></div>
    <div id="tags-cloud" class="tags-cloud" style="margin-top:10px;"></div>
  </section>
</main>

<!-- Embedded fallback data (used only if CSVs can’t be fetched locally) -->
<script type="text/plain" id="embedded-signals">
keyword,volume,growth_rate,last_seen,tags
"glazed blush",78,22,"2025-09-12","beauty, makeup"
"vanilla girl",40,5,"2025-08-28","fashion, lifestyle"
"quiet luxury",95,-8,"2025-07-05","fashion"
"skin cycling",60,18,"2025-09-10","beauty, skincare"
"blue beauty",30,35,"2025-08-31","beauty, sustainability"
"olfactory branding",22,41,"2025-09-09","retail, experience"
"biodegradable glitter",18,55,"2025-09-13","beauty, materials"
"spa water 2.0",15,8,"2025-08-22","wellness, drinks"
"augmented try-on",55,27,"2025-09-11","beauty, tech"
"fermented skincare",28,12,"2025-08-30","beauty, skincare"
"regenerative cotton",20,33,"2025-09-01","fashion, sustainability"
"scalp care",42,9,"2025-09-07","beauty, hair"
"refillable packaging",36,14,"2025-09-06","beauty, packaging"
"circadian lighting",25,31,"2025-09-02","home, wellness"
"athleisure tailoring",32,6,"2025-08-29","fashion"
</script>

<script type="text/plain" id="embedded-articles">
keyword,title,url,source,date
"glazed blush","Why Glazed Blush Is Everywhere","https://example.com/glazed-blush-trend","BeautyDaily","2025-09-11"
"glazed blush","A Pro Guide to Glazed Cheeks","https://example.com/glazed-cheeks-guide","MakeupLab","2025-09-10"
"skin cycling","Derms on Skin Cycling","https://example.com/skin-cycling-derms","SkincareNow","2025-09-09"
"blue beauty","Blue Beauty: Beyond Green","https://example.com/blue-beauty-future","EcoCosmetics","2025-08-30"
"olfactory branding","How Scent Sells","https://example.com/olfactory-branding-retail","RetailSense","2025-09-08"
"refillable packaging","Refillables Go Mainstream","https://example.com/refillable-packaging","PackWatch","2025-09-03"
"augmented try-on","AR Try-On Boosts Conversion","https://example.com/ar-try-on-stats","TechRetail","2025-09-12"
</script>

<script>
/* ===== Optional CSV paths (use if you have real files locally) ===== */
const SIGNALS_CSV_URL  = 'data/signals.csv';
const ARTICLES_CSV_URL = 'data/articles.csv';

/* ===== Helpers ===== */
const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
function minmaxNormalize(values){ const a=values.map(v => (isFinite(+v)?+v:0)); const mn=Math.min(...a), mx=Math.max(...a); if(!isFinite(mn)||!isFinite(mx)||mx===mn) return a.map(_=>0); return a.map(v => ((v-mn)/(mx-mn))*100); }
function recencyScoreFromDateStr(s){ const now=new Date(); const d=new Date(s); if(isNaN(d))return 0; const days=(now-d)/(1000*60*60*24); return clamp(100 - (days/90)*100, 0, 100); }
function parseCSVObjects(text){
  const rows=[], pushF=(r,f)=>{r.push(f)}, pushR=r=>rows.push(r);
  let i=0, f='', q=false, r=[];
  while(i<text.length){ const c=text[i];
    if(q){ if(c=='"'){ if(text[i+1]=='"'){f+='"'; i++} else q=false } else f+=c }
    else { if(c=='"') q=true; else if(c==','){ pushF(r,f); f=''; } else if(c=='\r'){} else if(c=='\n'){ pushF(r,f); f=''; pushR(r); r=[]; } else f+=c }
    i++;
  }
  if(f.length||r.length){ pushF(r,f); pushR(r); }
  if(!rows.length) return [];
  const header=rows[0].map(h=>h.trim());
  return rows.slice(1).filter(rr=>rr.some(v=>String(v).trim()!=='')).map(rr=>Object.fromEntries(header.map((h,idx)=>[h, rr[idx]??''])));
}
async function loadCSVMaybe(url, fallbackId){
  try{
    if(!/^https?:/.test(location.protocol)) throw new Error('not-http');
    const resp=await fetch(url,{cache:'no-store'}); if(!resp.ok) throw new Error('missing');
    const text=await resp.text(); const rows=parseCSVObjects(text); if(rows.length) return {rows,source:'csv'};
  }catch(e){}
  const emb=document.getElementById(fallbackId)?.textContent?.trim()||''; return {rows:parseCSVObjects(emb), source:'sample'};
}
function makeBar(el, labels, data, label, onClickIndex){
  const ctx=document.getElementById(el).getContext('2d'); if(window[el]) window[el].destroy?.();
  const chart=new Chart(ctx,{ type:'bar', data:{labels, datasets:[{label, data, borderWidth:1}]}, options:{
    responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}},
    onClick(_,els){ if(els?.length){ onClickIndex?.(els[0].index); } }
  }});
  window[el]=chart; return chart;
}

/* ===== Global ===== */
let SIGNAL_ROWS=[], ARTICLE_ROWS=[], ARTICLES_MAP = new Map();
let trendScores=[], momentumScores=[], volN=[], groN=[], recN=[];
let RANKED_SIGNALS=[], SIGNALS_CHART=null, OPP_CHART=null;

/* ===== Boot ===== */
(async function(){
  // 1) Load signals & articles (CSV or embedded)
  const {rows:sRows, source:sSrc}=await loadCSVMaybe(SIGNALS_CSV_URL,'embedded-signals');
  const {rows:aRows}=await loadCSVMaybe(ARTICLES_CSV_URL,'embedded-articles');
  SIGNAL_ROWS=sRows; ARTICLE_ROWS=aRows;

  // 2) Merge with any articles cached by index.html in localStorage
  const LS_KEYS = ['futures_articles','futures_edit_articles','futures_articles_by_keyword'];
  LS_KEYS.forEach(k=>{
    try{
      const raw = localStorage.getItem(k);
      if(!raw) return;
      const data = JSON.parse(raw);
      const arr = Array.isArray(data) ? data : (typeof data==='object' ? Object.values(data).flat() : []);
      arr.forEach(o=>{
        const keyword = String(o.keyword||o.signal||o.topic||'').trim();
        const title   = o.title || o.headline || '';
        const url     = o.url || o.link || '';
        const source  = o.source || o.publisher || (url? new URL(url).hostname.replace(/^www\./,''):'');
        const date    = o.date || o.published_at || o.pubDate || '';
        if(keyword && title && url){
          ARTICLE_ROWS.push({keyword,title,url,source,date});
        }
      });
    }catch{}
  });

  // 3) Deduplicate articles
  const seen = new Set();
  ARTICLE_ROWS = ARTICLE_ROWS.filter(a=>{
    const key = (String(a.keyword).toLowerCase() || '') + '|' + (a.url||'').split('#')[0].split('?')[0];
    if(seen.has(key)) return false; seen.add(key); return true;
  });

  // 4) Index articles by keyword
  ARTICLES_MAP = new Map();
  ARTICLE_ROWS.forEach(a=>{
    const k = String((a.keyword||'')).toLowerCase();
    if(!ARTICLES_MAP.has(k)) ARTICLES_MAP.set(k, []);
    ARTICLES_MAP.get(k).push(a);
  });

  document.getElementById('dataset-meta').textContent=`${SIGNAL_ROWS.length} signals • ${ARTICLE_ROWS.length} articles • ${new Date().toISOString().slice(0,10)} • ${sSrc}`;
  if(!SIGNAL_ROWS.length) return;

  const get=(r,k)=>r[k] ?? r[k?.toLowerCase?.()] ?? r[k?.toUpperCase?.()];
  const keywords=SIGNAL_ROWS.map(r=>String(get(r,'keyword')??'').trim()||'(untitled)');
  const volumes =SIGNAL_ROWS.map(r=>isFinite(+get(r,'volume'))?+get(r,'volume'):0);
  const growths0=SIGNAL_ROWS.map(r=>isFinite(+get(r,'growth_rate'))?+get(r,'growth_rate'):0);
  const growths =growths0.map(v=>Math.max(0,v));
  const recency =SIGNAL_ROWS.map(r=>recencyScoreFromDateStr(get(r,'last_seen')));
  const tagsRaw =SIGNAL_ROWS.map(r=>String(get(r,'tags')||'').split(',').map(s=>s.trim()).filter(Boolean));

  volN=minmaxNormalize(volumes); groN=minmaxNormalize(growths); recN=recency;
  const noveltyN = volN.map(v=>100 - v);
  trendScores = volN.map((_,i)=>Math.round(0.40*volN[i] + 0.40*groN[i] + 0.20*recN[i]));
  momentumScores = volN.map((_,i)=>Math.round(0.55*groN[i] + 0.35*recN[i] + 0.10*noveltyN[i]));

  /* ===== 1) Momentum — Breakouts Top 15 ===== */
  const rankedMomentum = keywords.map((k,i)=>({k, m:momentumScores[i]})).sort((a,b)=>b.m-a.m).slice(0,15);
  makeBar('momentumChart', rankedMomentum.map(d=>d.k), rankedMomentum.map(d=>d.m), 'Momentum (0–100)');
  document.getElementById('momentum-meta').textContent=`(Top ${rankedMomentum.length} of ${SIGNAL_ROWS.length} signals)`;

  /* ===== 2) Signals — chart + panel ===== */
  function buildRank(mode='trend'){
    RANKED_SIGNALS = keywords.map((k,i)=>({
      idx:i, keyword:k,
      score:trendScores[i], momentum:momentumScores[i],
      volume:volumes[i], growth:growths0[i],
      lastSeen:get(SIGNAL_ROWS[i],'last_seen'),
      tags:tagsRaw[i],
      volN:Math.round(volN[i]), groN:Math.round(groN[i]), recN:Math.round(recN[i])
    }));
    if(mode==='volume') RANKED_SIGNALS.sort((a,b)=> (b.volume||0)-(a.volume||0));
    else if(mode==='growth') RANKED_SIGNALS.sort((a,b)=> (b.growth||0)-(a.growth||0));
    else if(mode==='momentum') RANKED_SIGNALS.sort((a,b)=> (b.momentum||0)-(a.momentum||0));
    else RANKED_SIGNALS.sort((a,b)=> (b.score||0)-(a.score||0)); // trend
    return RANKED_SIGNALS.slice(0,25);
  }
  function renderSignals(mode='trend'){
    const top=buildRank(mode);
    document.getElementById('signals-meta').textContent=`(Top ${top.length} by ${mode==='volume'?'Volume':mode==='growth'?'Growth %':mode==='momentum'?'Momentum':'Trend Score'})`;
    makeBar('signalsChart', top.map(d=>d.keyword),
      top.map(d=> mode==='volume'?d.volume : mode==='growth'?d.growth : mode==='momentum'?d.momentum : d.score),
      mode==='volume'?'Volume':mode==='growth'?'Growth %':mode==='momentum'?'Momentum (0–100)':'Trend Score (0–100)',
      (i)=>selectSignal(top[i]));
  }
  renderSignals('trend');
  document.getElementById('rank-by').addEventListener('change', e=>renderSignals(e.target.value));

  function stageLabel(d){
    const m=d.momentum||0, t=d.score||0;
    if (m>=70 && t<60) return '· [Breakout]';
    if (m>=60 && t>=60) return '· [Emerging]';
    if (t>=75 && m<55) return '· [Established]';
    if (t<50 && m<45)  return '· [Cooling]';
    return '· [Developing]';
  }

  function selectSignal(d){
    if(!d) return;
    document.getElementById('signal-title').textContent=d.keyword + ' ' + stageLabel(d);
    const tagsEl=document.getElementById('signal-tags'); tagsEl.innerHTML='';
    (d.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsEl.appendChild(s); });
    document.getElementById('kpi-score').textContent=isFinite(d.score)?d.score:'–';
    document.getElementById('kpi-momentum').textContent=isFinite(d.momentum)?d.momentum:'–';
    document.getElementById('kpi-volume').textContent=isFinite(d.volume)?d.volume:'–';
    document.getElementById('kpi-growth').textContent=isFinite(d.growth)?d.growth:'–';
    document.getElementById('kpi-lastseen').textContent=d.lastSeen||'–';

    // Related articles — real links, show more/less, actions
    const key = String(d.keyword).toLowerCase();
    const arts=(ARTICLES_MAP.get(key)||[]);
    const countEl = document.getElementById('articles-count');
    countEl.textContent = `${arts.length} article${arts.length===1?'':'s'} found`;
    renderArticlesList(arts, 8); // default show 8

    // Actions
    document.getElementById('open-top5').onclick = ()=> {
      arts.slice(0,5).forEach(a=>{ if(a.url) window.open(a.url, '_blank', 'noopener'); });
    };
    document.getElementById('copy-citations').onclick = async ()=>{
      const blob = arts.slice(0,20).map(a=>{
        const src = a.source || (a.url? new URL(a.url).hostname.replace(/^www\./,''):'');
        return `- ${a.title} (${src}${a.date?`, ${a.date}`:''}): ${a.url}`;
      }).join('\n');
      try{ await navigator.clipboard.writeText(blob); }catch{}
    };

    // Content kit hooks
    document.getElementById('gen-kit').onclick = ()=> generateKit(d, arts);
    document.getElementById('copy-kit').onclick = copyKitAll;
  }

  function renderArticlesList(arts, initial=8){
    const list=document.getElementById('articles-list');
    const moreWrap=document.getElementById('articles-more');
    const btnMore=document.getElementById('btn-show-more');
    const btnLess=document.getElementById('btn-show-less');
    let expanded=false;

    function draw(){
      const shown = expanded ? arts : arts.slice(0, initial);
      const frag=document.createElement('div');
      shown.forEach(a=>{
        const date=a.date ? new Date(a.date).toISOString().slice(0,10) : '';
        const host = a.source || (a.url? new URL(a.url).hostname.replace(/^www\./,''):'');
        const div=document.createElement('div'); div.className='linkline'; div.style.marginBottom='8px';
        div.innerHTML = `<a href="${a.url}" target="_blank" rel="noopener">${a.title||a.url}</a><br><small>${host}${date?` • ${date}`:''}</small>`;
        frag.appendChild(div);
      });
      list.innerHTML=''; list.appendChild(frag);
      if(arts.length > initial){
        moreWrap.style.display='block';
        btnMore.style.display = expanded ? 'none' : 'inline-flex';
        btnLess.style.display = expanded ? 'inline-flex' : 'none';
      } else {
        moreWrap.style.display='none';
      }
    }
    btnMore.onclick = ()=>{ expanded=true; draw(); };
    btnLess .onclick = ()=>{ expanded=false; draw(); };
    draw();
  }

  function makeSummary(d){
    const heat=v=>v>=75?'very high':v>=50?'high':v>=25?'moderate':'low';
    const volNote=`Volume ${isFinite(d.volume)?d.volume:'–'} (${heat(d.volN)})`;
    const groNote=`growth ${isFinite(d.growth)?d.growth+'%':'–'} (${heat(d.groN)})`;
    const recNote=`recency ${heat(d.recN)}${d.lastSeen?`; last seen ${d.lastSeen}`:''}`;
    const tags=(d.tags&&d.tags.length)?`Tags: ${d.tags.join(', ')}`:'';
    return `${d.keyword} — Trend ${d.score}, Momentum ${d.momentum}. ${volNote}, ${groNote}, ${recNote}. ${tags}`.trim();
  }
  document.getElementById('copy-summary').onclick = async ()=>{
    const sel = RANKED_SIGNALS[0]; if(!sel) return;
    try{ await navigator.clipboard.writeText(makeSummary(sel)); }catch{}
  };
  selectSignal(buildRank('trend')[0]);

  /* ===== 3) Opportunity — What to cover now (no Feasibility) ===== */
  function verticalsFromTags(tags){
    const t = (tags||[]).map(x=>x.toLowerCase());
    const hasFashion = t.some(x=> /fashion|style|apparel|tailor|couture|athleisure/.test(x));
    const hasBeauty  = t.some(x=> /beauty|skincare|skin|makeup|hair|fragrance|cosmetic/.test(x));
    const hasWell    = t.some(x=> /wellness|health|fitness|sleep|spa|home|lifestyle|nutrition/.test(x));
    let count = 0; if (hasFashion) count++; if (hasBeauty) count++; if (hasWell) count++;
    return { count };
  }
  function whyNow(d, artCount, cross){
    const bits=[];
    if ((d.momentum||0) >= 65) bits.push('fast acceleration');
    if ((d.recN||0) >= 70) bits.push('very recent');
    if (artCount === 0) bits.push('white space (no coverage)');
    else if (artCount <= 2) bits.push('low coverage');
    if (cross.count >= 2) bits.push('cross-vertical potential');
    if ((d.score||0) >= 70) bits.push('high baseline interest');
    return bits.length ? bits.join(' · ') : 'steady signal';
  }
  function computeOpportunity(){
    const articleCounts = SIGNAL_ROWS.map((_,i)=>{
      const key = String((keywords[i]||'').toLowerCase());
      return (ARTICLES_MAP.get(key)||[]).length;
    });
    const saturationN = minmaxNormalize(articleCounts);
    const crossN = SIGNAL_ROWS.map((_,i)=> Math.round((verticalsFromTags(tagsRaw[i]).count/3)*100));
    const opp = SIGNAL_ROWS.map((_,i)=> Math.round(
      0.55*(momentumScores[i]||0) + 0.30*(100 - (saturationN[i]||0)) + 0.15*(crossN[i]||0)
    ));

    const rows = SIGNAL_ROWS.map((_,i)=>({
      keyword: keywords[i],
      opportunity: opp[i],
      momentum: momentumScores[i],
      trend: trendScores[i],
      volume: volumes[i],
      growth: growths0[i],
      recN: Math.round(recN[i]),
      articles: (ARTICLES_MAP.get(String(keywords[i].toLowerCase()))||[]).length,
      cross: verticalsFromTags(tagsRaw[i])
    })).sort((a,b)=> b.opportunity - a.opportunity);

    return { rows };
  }
  function renderOpportunity(){
    const { rows } = computeOpportunity();
    const top = rows.slice(0,12);
    OPP_CHART = makeBar('oppChart', top.map(d=>d.keyword), top.map(d=>d.opportunity), 'Opportunity (0–100)',
      (i)=> {
        const sel = RANKED_SIGNALS.find(r => r.keyword === top[i].keyword) || { keyword: top[i].keyword, score: top[i].trend, momentum: top[i].momentum, volume: top[i].volume, growth: top[i].growth, lastSeen: '', tags: [] , volN:0, groN:0, recN: top[i].recN};
        selectSignal(sel);
        document.getElementById('rank-by').value = 'trend';
        renderSignals('trend');
      });
    document.getElementById('opp-meta').textContent = `(Top ${top.length} by Opportunity)`;

    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr>
      <th>#</th><th>Signal</th><th>Opp</th><th>Momentum</th><th>Articles</th><th>Why now</th>
    </tr></thead><tbody></tbody>`;
    top.forEach((d,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td><b>${d.keyword}</b></td>
        <td>${d.opportunity}</td>
        <td class="muted">${d.momentum}</td>
        <td class="muted">${d.articles}</td>
        <td class="why">${whyNow(d, d.articles, d.cross)}</td>`;
      tbl.querySelector('tbody').appendChild(tr);
    });
    const wrap = document.getElementById('opp-table'); wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  renderOpportunity();

  /* ===== 4) Top Tags ===== */
  const tagCounts=new Map();
  tagsRaw.forEach(list=>list.forEach(t=>tagCounts.set(t,(tagCounts.get(t)||0)+1)));
  const tagsSorted=Array.from(tagCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,25);
  document.getElementById('tags-meta').textContent=tagsSorted.length?`(Top ${tagsSorted.length})`:'(no tags found)';
  if(tagsSorted.length){
    makeBar('tagsBarChart', tagsSorted.map(([t])=>t), tagsSorted.map(([,c])=>c), 'Count');
    const cloud=document.getElementById('tags-cloud'); tagsSorted.forEach(([t,c])=>{ const s=document.createElement('span'); s.className='tag-pill'; s.textContent=`${t} • ${c}`; cloud.appendChild(s); });
  }

  /* ===== Simple Content Kit ===== */
  function bulletImplications(tags){
    const t=(tags||[]).map(x=>x.toLowerCase()); const out=[];
    if (t.includes('tech')) out.push('Test AR try-on or AI sizing in 1 category');
    if (t.includes('skincare')) out.push('Bundle ritual steps; tie claims to routines');
    if (t.includes('fragrance')) out.push('Use scent zoning & sampling to basket-build');
    if (t.includes('packaging')) out.push('Pilot mono-material or refill format');
    if (t.includes('sustainability')) out.push('Publish measured impact, not claims');
    if (!out.length) out.push('Pilot with 1 hero SKU + creator narrative');
    return out.slice(0,3);
  }
  function kpisForTags(tags){
    const t=(tags||[]).map(x=>x.toLowerCase()); const k=[];
    if (t.includes('tech')) k.push('Try-on adoption %','Conversion lift vs control','Return-rate change');
    if (t.includes('skincare')) k.push('Regimen attach rate','Repeat purchase','AOV change');
    if (t.includes('fragrance')) k.push('Sample→purchase %','Dwell time','Basket size');
    if (t.includes('packaging')) k.push('Refill return %','Material cost delta','NPS on packaging');
    if (!k.length) k.push('CTR to PDP','Add-to-cart rate','Share of voice');
    return k.slice(0,3);
  }
  function evidenceBullets(articles){
    return (articles||[]).slice(0,3).map(a=>{
      const src = a.source || (a.url? new URL(a.url).hostname.replace(/^www\./,''):'');
      const dt  = a.date || '';
      return `${src}${dt?` (${dt})`:''}`;
    });
  }
  function generateKit(d, articles){
    const title = d.keyword;
    const tags = d.tags || [];
    const facts = `Momentum ${d.momentum||0}, Trend ${d.score||0}, volume ${d.volume||0}, growth ${d.growth||0}%, recency ${d.recN||0}`;
    const implications = bulletImplications(tags);
    const kpis = kpisForTags(tags);
    const sources = evidenceBullets(articles);
    const evidence = sources.length ? `Evidence: ${sources.join(', ')}.` : '';

    // Executive takeaway (1-liner)
    const takeaway = `${title} — ${implications[0]}. ${facts}.`;

    // Newsletter (~150 words)
    const nl = [
      `**${title}** — ${implications[0]}.`,
      `Why it matters: ${implications.join('; ')}.`,
      `${facts}.`,
      evidence,
      `What we’re watching: creator adoption, retail UX, and conversion lift.`,
      `Reply for the one-pager or to scope a brand-specific pilot.`
    ].join(' ');

    // LinkedIn post
    const li = [
      `⚡ ${title}`,
      ``,
      `• ${implications[0]}`,
      `• ${implications[1]||'Run a 2-week A/B in one category'}`,
      `• ${implications[2]||'Define 2–3 KPIs and measure'}`,
      ``,
      `Stats: ${facts}`,
      sources.length ? `Sources: ${sources.join(' · ')}` : '',
      ``,
      `👉 DM for the checklist or a working session.`
    ].filter(Boolean).join('\n');

    // Social hooks (3)
    const hooks = [
      `${title}: the micro-trend brands keep missing`,
      `${title} → from hype to impact`,
      `3 ways to activate ${title}`
    ].join('\n');

    // KPIs (3)
    const kpisTxt = kpis.join(' • ');

    // Write to UI
    const out = (id, text) => document.getElementById(id).textContent = text;
    document.getElementById('kit-out').style.display='block';
    out('kit-takeaway', takeaway);
    out('kit-news', nl);
    out('kit-li', li);
    out('kit-hooks', hooks);
    out('kit-kpis', kpisTxt);
  }
  async function copyKitAll(){
    const blocks = [
      ['EXECUTIVE TAKEAWAY','kit-takeaway'],
      ['NEWSLETTER','kit-news'],
      ['LINKEDIN','kit-li'],
      ['HOOKS','kit-hooks'],
      ['KPIs','kit-kpis'],
    ].map(([label,id]) => `## ${label}\n\n${document.getElementById(id).textContent||''}`).join('\n\n');
    try{ await navigator.clipboard.writeText(blocks); }catch{}
  }
})();
</script>
