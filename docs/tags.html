<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Signals — Graphs & Insights</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#141414; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --accent:#111827;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --ctl-w:180px;
    --ok:#22c55e; --warn:#f59e0b; --soft:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#2563eb;text-decoration:none}
  .bar{position:sticky;top:0;z-index:20;backdrop-filter:saturate(180%) blur(10px);
    background:color-mix(in oklab, var(--bg) 92%, transparent);
    border-bottom:1px solid var(--border)}
  .bar-inner{max-width:1100px;margin:0 auto;padding:12px 20px;
    display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .title{font-weight:700}
  .btn, .select, .input{
    background:var(--card); color:var(--fg); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; box-shadow:var(--shadow);
  }
  .select{width:var(--ctl-w)} .spacer{flex:1}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
  .grid{display:grid;gap:16px}
  @media(min-width:1024px){ .grid.two{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);
    border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .card.sm{padding:10px}
  .legend{color:var(--muted);font-size:12px;margin-top:6px}
  .mini{max-width:100%}
  .mini.sm{height:160px !important}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:10px 0}
  .small{font-size:12px;color:var(--muted)}
  .pill{ padding:4px 8px; font-size:11px; line-height:1;
    border:1px solid var(--border); border-radius:999px; background:var(--pill);}
  .kpi{display:flex; gap:12px; margin:8px 0 4px}
  .kpi .pill{font-size:12px}
  ul.list{list-style:none; padding:0; margin:8px 0 0; max-height:160px; overflow:auto}
  ul.list li{display:flex; justify-content:space-between; gap:10px;
    padding:6px 0; border-bottom:1px dashed var(--border)}
  .muted{color:var(--muted)}
  .line-two{display:grid; gap:16px}
  @media(min-width:760px){ .line-two{grid-template-columns:1fr 1fr} }
</style>

<div class="bar">
  <div class="bar-inner">
    <a class="btn" href="./">← Signals list</a>
    <div class="title">Graphs & Insights</div>
    <select id="cat" class="select">
      <option value="">All categories</option>
      <option>fashion</option><option>beauty</option><option>wellness</option>
    </select>
    <select id="stat" class="select">
      <option value="">All status</option>
      <option>emerging</option><option>bubbling</option><option>mainstream</option>
    </select>
    <input id="from" type="date" class="input">
    <input id="to"   type="date" class="input">
    <select id="quick" class="select">
      <option value="">All time</option>
      <option value="30">Last 30 days</option>
      <option value="90">Last 90 days</option>
      <option value="180">Last 180 days</option>
    </select>
    <button id="clear" class="btn">Clear</button>
  </div>
</div>

<div class="wrap">
  <div class="row">
    <label class="small">Top keywords
      <input id="topN" type="range" min="5" max="25" step="1" value="25" style="margin-left:6px">
      <span id="topNVal" class="small">25</span>
    </label>
    <label class="small">Filter keywords…
      <input id="kwSearch" type="search" class="input" placeholder="type to filter bar" style="width:220px">
    </label>
    <span id="metaCount" class="pill">…</span>
  </div>

  <!-- Row 1: Top keywords + Keyword details -->
  <div class="grid two">
    <div class="card">
      <h3>Top keywords</h3>
      <canvas id="chartKeywords" class="mini"></canvas>
      <div class="legend">Click a bar to inspect that keyword.</div>
    </div>
    <div class="card" id="kwPanel">
      <h3>Keyword details <span id="kwTitle" class="small" style="margin-left:8px;color:var(--muted)">(click a keyword)</span></h3>
      <div class="kpi" id="kwKpis" style="display:none">
        <span class="pill" id="kpiTotal">Total: 0</span>
        <span class="pill" id="kpiAvg">Avg score: 0</span>
        <span class="pill" id="kpiCat">Top category: –</span>
        <a class="btn" id="openList" target="_blank" rel="noopener">Open in list</a>
      </div>
      <canvas id="chartKwStatus" class="mini"></canvas>
      <div class="legend">Status mix for the selected keyword.</div>
      <h4 class="small" style="margin-top:10px">Latest articles</h4>
      <ul id="kwList" class="list"></ul>
    </div>
  </div>

  <!-- Row 2: Compact sources + status mix -->
  <div class="line-two" style="margin-top:16px">
    <div class="card sm">
      <h3>Top sources (share)</h3>
      <canvas id="chartSources" class="mini sm"></canvas>
      <div class="legend">Top 10 domains by share (others grouped).</div>
    </div>
    <div class="card sm">
      <h3>Status mix by category</h3>
      <canvas id="chartMix" class="mini sm"></canvas>
      <div class="legend">100% stacked bars: emerging / bubbling / mainstream by category.</div>
    </div>
  </div>

  <!-- Row 3: Momentum & early signals -->
  <div class="grid two" style="margin-top:16px">
    <div class="card">
      <h3>Fastest-rising keywords (current vs previous)</h3>
      <canvas id="chartRisers" class="mini"></canvas>
      <div class="legend">
        Change in mentions between the current filters and a same-length previous window.
      </div>
    </div>
    <div class="card">
      <h3>Newcomer keywords (first appearances)</h3>
      <ul id="newcomersList" class="list"></ul>
      <div class="legend">
        Keywords that didn’t appear in the previous window but do appear now.
      </div>
    </div>
  </div>

  <!-- Row 4: Methodology -->
  <div class="card" style="margin-top:16px">
    <h3>Methodology & notes</h3>
    <div class="legend" style="font-size:13px">
      We track <b>fashion, beauty, and wellness</b> signals from articles and tag each one
      with a keyword, status, and category. Filters define the <b>current window</b>.
      For momentum, we compare against a <b>same-length previous window</b>.
      <br><br>
      This gives editorially useful views: volume (Top keywords),
      distribution (Status mix), source balance (Top sources),
      momentum (Fastest-rising), and early signals (Newcomers).
    </div>
  </div>
</div>

<script>
/* --- Keyword normalization --- */
const KW_MAP = new Map([
  ['anti aging','longevity'], ['anti-ageing','longevity'],
  ['lip-oil','lip oil'], ['lip oils','lip oil'],
  ['old money','quiet luxury'], ['stealth wealth','quiet luxury'],
  ['westernwear','western'], ['cowboy core','western'],
]);
const KW_STOP = new Set([
  'trend','trends','report','collection','editorial','new','drop','style','looks',
  'runway','season','fall','winter','spring','summer','2024','2025','brand','product',
  'line','launch','best','top','dress','shirt','pants','jeans','skirt','bag','bags','shoes'
]);
function normalizeKw(raw){
  if(!raw) return '';
  let s = String(raw).toLowerCase().trim();
  s = s.replace(/[–—]/g,'-').replace(/\s+/g,' ');
  if (s.endsWith('s') && s.length > 4) s = s.slice(0,-1);
  if (KW_MAP.has(s)) s = KW_MAP.get(s);
  if (s.length < 3 || KW_STOP.has(s)) return '';
  return s;
}
function getKw(r){ return normalizeKw(r.primary_keyword||''); }

/* --- state --- */
let rowsAll = [];
let charts = {};
let selectedKw = "";

/* --- helpers --- */
const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
function hostOf(u){ try{ return new URL(u).host.replace(/^www\./,''); }catch{return ""; } }
function inRange(iso, from, to){
  const t = Date.parse(iso||""); if(isNaN(t)) return false;
  if(from && t < new Date(from).setUTCHours(0,0,0,0)) return false;
  if(to   && t > new Date(to).setUTCHours(23,59,59,999)) return false;
  return true;
}
function palette(n){ const base=['#2563eb','#0891b2','#10b981','#84cc16','#f59e0b','#ef4444','#a855f7','#ec4899','#14b8a6','#22c55e','#eab308']; return Array.from({length:n},(_,i)=>base[i%base.length]); }

/* --- filters --- */
function getFiltered(){
  const cat=document.getElementById('cat').value;
  const stat=document.getElementById('stat').value;
  const from=document.getElementById('from').value;
  const to=document.getElementById('to').value;
  return rowsAll.filter(r=>{
    if(cat && r.category!==cat) return false;
    if(stat && (r.status||'').toLowerCase()!==stat) return false;
    if(from||to){ if(!inRange(r.published,from,to)) return false; }
    return true;
  });
}
function getWindowBounds(){
  const today=new Date();
  const curTo=(document.getElementById('to').value?new Date(document.getElementById('to').value):today);
  const curFrom=(document.getElementById('from').value?new Date(document.getElementById('from').value):new Date(today.getTime()-90*86400000));
  const lenMs=curTo-curFrom;
  const prevTo=new Date(curFrom.getTime()-1);
  const prevFrom=new Date(prevTo.getTime()-lenMs+1);
  return {curFrom,curTo,prevFrom,prevTo};
}
function rowsInRange(rows, from, to){
  const isoFrom=from.toISOString().slice(0,10);
  const isoTo=to.toISOString().slice(0,10);
  return rows.filter(r=>inRange(r.published,isoFrom,isoTo));
}

/* --- charts --- */
function makeOrUpdate(id, type, data, opt){
  const ctx=document.getElementById(id);
  if(charts[id]){ charts[id].data=data; charts[id].options=opt; charts[id].update(); return charts[id]; }
  charts[id]=new Chart(ctx,{type,data,options:opt}); return charts[id];
}

/* --- computations --- */
function topKeywords(rows, limit, filterTxt){
  const m=new Map();
  for(const r of rows){ const k=getKw(r); if(!k) continue; m.set(k,(m.get(k)||0)+1); }
  let arr=[...m.entries()];
  if(filterTxt){ const re=new RegExp(escRe(filterTxt),'i'); arr=arr.filter(([k])=>re.test(k)); }
  arr.sort((a,b)=>b[1]-a[1]);
  return arr.slice(0,limit);
}
function statusMixByCategory(rows){
  const cats=['fashion','beauty','wellness'];
  const stats=['emerging','bubbling','mainstream'];
  const table=cats.map(c=>{
    const sub=rows.filter(r=>r.category===c);
    const counts=stats.map(s=>sub.filter(r=>(r.status||'').toLowerCase()===s).length);
    const tot=counts.reduce((a,b)=>a+b,0)||1;
    return counts.map(v=>v/tot*100);
  });
  return {cats, stats, perc:table};
}
function topSourcesShare(rows){
  const map=new Map();
  for(const r of rows){ const h=hostOf(r.link); if(!h) continue; map.set(h,(map.get(h)||0)+1); }
  const sorted=[...map.entries()].sort((a,b)=>b[1]-a[1]);
  const top=sorted.slice(0,10);
  const others=sorted.slice(10).reduce((s,[,v])=>s+v,0);
  if(others>0) top.push(["others",others]);
  return top;
}
function countKeywords(rows){
  const m=new Map();
  for(const r of rows){ const k=getKw(r); if(!k) continue; m.set(k,(m.get(k)||0)+1); }
  return m;
}
function fastestRisers(curRows, prevRows, top=12){
  const cur=countKeywords(curRows), prev=countKeywords(prevRows);
  const set=new Set([...cur.keys(),...prev.keys()]);
  const arr=[];
  for(const k of set){
    const c=cur.get(k)||0, p=prev.get(k)||0;
    const delta=c-p;
    if(c===0) continue;
    arr.push({k,delta});
  }
  arr.sort((a,b)=>b.delta-a.delta);
  return arr.slice(0,top);
}
function newcomerKeywords(curRows, prevRows, limit=20){
  const cur=countKeywords(curRows), prev=countKeywords(prevRows);
  const out=[];
  for(const [k,c] of cur.entries()){ if(c>0 && !prev.has(k)) out.push({k,c}); }
  out.sort((a,b)=>b.c-a.c);
  return out.slice(0,limit);
}
function avgScore(rows){
  const nums=rows.map(r=>parseFloat(r.trend_score||0)).filter(n=>!isNaN(n));
  if(!nums.length) return 0;
  return Math.round((nums.reduce((a,b)=>a+b,0)/nums.length)*100)/100;
}
function topCat(rows){
  const m=new Map(); for(const r of rows){ if(r.category) m.set(r.category,(m.get(r.category)||0)+1); }
  let best="",cnt=-1; m.forEach((v,k)=>{ if(v>cnt){cnt=v;best=k;} });
  return best||"–";
}

/* --- render --- */
function adjustKeywordsHeight(labelsCount=0){
  const n=labelsCount||(charts.chartKeywords?.data?.labels?.length||0);
  const h=Math.min(1200,Math.max(220,22*n+40));
  document.getElementById('chartKeywords').style.height=h+"px";
}
function render(){
  const rows=getFiltered();
  document.getElementById('metaCount').textContent=`${rows.length} articles in current filters`;
  // Top keywords
  const topK=topKeywords(rows,parseInt(document.getElementById('topN').value,10),
    document.getElementById('kwSearch').value.trim());
  adjustKeywordsHeight(topK.length);
  const kwChart=makeOrUpdate('chartKeywords','bar',{
    labels:topK.map(([k])=>k),
    datasets:[{label:'count',data:topK.map(([,v])=>v),backgroundColor:palette(topK.length)}]
  },{
    responsive:true,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}
  });
  charts.chartKeywords=kwChart;
  kwChart.options.onClick=(e)=>{
    const p=kwChart.getElementsAtEventForMode(e,'nearest',{intersect:true},true);
    if(!p.length) return;
    selectedKw=kwChart.data.labels[p[0].index]; renderKwDetails(rows);
  };
  if(selectedKw) renderKwDetails(rows); else resetKwDetails();
  // Sources
  const src=topSourcesShare(rows);
  makeOrUpdate('chartSources','doughnut',{
    labels:src.map(([h])=>h),
    datasets:[{data:src.map(([,v])=>v),backgroundColor:palette(src.length)}]
  },{plugins:{legend:{position:'bottom'}},cutout:'55%'});
  // Status mix
  const ok=cssVar('--ok'),warn=cssVar('--warn'),soft=cssVar('--soft');
  const mix=statusMixByCategory(rows);
  makeOrUpdate('chartMix','bar',{
    labels:mix.cats,
    datasets:[
      {label:'emerging',data:mix.perc.map(r=>r[0]),backgroundColor:ok},
      {label:'bubbling',data:mix.perc.map(r=>r[1]),backgroundColor:warn},
      {label:'mainstream',data:mix.perc.map(r=>r[2]),backgroundColor:soft},
    ]
  },{
    responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true,max:100}},
    plugins:{legend:{position:'bottom'}}
  });
  // Momentum & newcomers
  const {curFrom,curTo,prevFrom,prevTo}=getWindowBounds();
  const curRows=rowsInRange(rowsAll,curFrom,curTo);
  const prevRows=rowsInRange(rowsAll,prevFrom,prevTo);
  const risers=fastestRisers(curRows,prevRows,12);
  makeOrUpdate('chartRisers','bar',{
    labels:risers.map(r=>r.k),
    datasets:[{data:risers.map(r=>r.delta),backgroundColor:palette(risers.length)}]
  },{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}});
  const newbies=newcomerKeywords(curRows,prevRows,20);
  document.getElementById('newcomersList').innerHTML=
    newbies.map(n=>`<li><span>${n.k}</span><span class="muted">+${n.c}</span></li>`).join('')
    || `<li class="muted">No newcomers.</li>`;
}
function cssVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()||name;}
function resetKwDetails(){
  document.getElementById('kwTitle').textContent='(click a keyword)';
  document.getElementById('kwKpis').style.display='none';
  document.getElementById('kwList').innerHTML='';
  makeOrUpdate('chartKwStatus','bar',{labels:[],datasets:[]},{});
}
function renderKwDetails(){
  if(!selectedKw){ resetKwDetails(); return; }
  document.getElementById('kwTitle').textContent=selectedKw;
  const rows=getFiltered();
  const rkw=rows.filter(r=>getKw(r)===normalizeKw(selectedKw));
  document.getElementById('kpiTotal').textContent=`Total: ${rkw.length}`;
  document.getElementById('kpiAvg').textContent=`Avg score: ${avgScore(rkw)}`;
  document.getElementById('kpiCat').textContent=`Top category: ${topCat(rkw)}`;
  const p=new URLSearchParams(); p.set('q',selectedKw); p.set('view','table');
  document.getElementById('openList').href='./?'+p.toString();
  document.getElementById('kwKpis').style.display='flex';
  const ok=cssVar('--ok'),warn=cssVar('--warn'),soft=cssVar('--soft');
  const stats=['emerging','bubbling','mainstream'];
  const counts=stats.map(s=>rkw.filter(r=>(r.status||'').toLowerCase()===s).length);
  makeOrUpdate('chartKwStatus','bar',{
    labels:['status mix'],
    datasets:[
      {label:'emerging',data:[counts[0]],backgroundColor:ok},
      {label:'bubbling',data:[counts[1]],backgroundColor:warn},
      {label:'mainstream',data:[counts[2]],backgroundColor:soft},
    ]
  },{indexAxis:'y',scales:{x:{stacked:true,beginAtZero:true},y:{stacked:true}},plugins:{legend:{position:'bottom'}}});
  const latest=rkw.slice().sort((a,b)=>(Date.parse(b.published||0)||0)-(Date.parse(a.published||0)||0)).slice(0,8);
  document.getElementById('kwList').innerHTML=latest.map(r=>{
    const d=(r.published||"").slice(0,10); const t=r.title||"(untitled)";
    return `<li><a href="${r.link}" target="_blank" rel="noopener">${t}</a><span class="muted">${d}</span></li>`;
  }).join("")||`<li class="muted">No recent articles.</li>`;
}

/* --- load CSV --- */
function load(){
  const bust=new Date().toISOString().slice(0,10);
  fetch('signals_simple.csv?ts='+bust)
    .then(r=>r.text())
    .then(csv=>Papa.parse(csv,{header:true,skipEmptyLines:true}))
    .then(res=>{rowsAll=res.data; render();})
    .catch(()=>alert('Failed to load signals_simple.csv'));
}
load();
</script>
