<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tags Graph & Metrics</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#ffffff; --fg:#141414; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --pill:#f3f4f6; --accent:#111827;
    --shadow:0 8px 24px rgba(0,0,0,.06);
    --ctl-w:180px;
  }
  :root.dark{
    --bg:#0b0b0c; --fg:#f2f3f5; --muted:#a3a7ae;
    --card:#121317; --border:#2b2f36; --pill:#1b1f25; --accent:#e5e7eb;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#2563eb;text-decoration:none}
  .bar{position:sticky;top:0;z-index:20;backdrop-filter:saturate(180%) blur(10px);
    background:color-mix(in oklab, var(--bg) 92%, transparent); border-bottom:1px solid var(--border)}
  .bar-inner{max-width:1100px;margin:0 auto;padding:12px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .title{font-weight:700}
  .btn, .select, .input{
    background:var(--card); color:var(--fg); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; box-shadow:var(--shadow);
  }
  .select{width:var(--ctl-w)} .spacer{flex:1}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:1fr 1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .legend{color:var(--muted);font-size:12px;margin-top:6px}
  canvas{max-width:100%;height:340px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:10px 0}
  .small{font-size:12px;color:var(--muted)}
</style>

<div class="bar">
  <div class="bar-inner">
    <a class="btn" href="./">← Signals list</a>
    <div class="title">Tags Graph</div>

    <select id="cat" class="select">
      <option value="">All categories</option>
      <option>fashion</option><option>beauty</option><option>wellness</option>
    </select>
    <select id="stat" class="select">
      <option value="">All status</option>
      <option>emerging</option><option>bubbling</option><option>mainstream</option>
    </select>

    <input id="from" type="date" class="input">
    <input id="to"   type="date" class="input">
    <select id="quick" class="select">
      <option value="">All time</option>
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="90">Last 90 days</option>
    </select>
    <button id="clear" class="btn">Clear</button>

    <div class="spacer"></div>
    <button id="dark" class="btn">Toggle dark mode</button>
  </div>
</div>

<div class="wrap">
  <!-- Controls specific to charts -->
  <div class="row">
    <label class="small">Top keywords
      <input id="topN" type="range" min="5" max="60" step="1" value="30" style="vertical-align:middle;margin-left:6px">
      <span id="topNVal" class="small">30</span>
    </label>
    <label class="small">Find keyword…
      <input id="kwSearch" type="search" class="input" placeholder="type to filter bar chart" style="width:220px">
    </label>
    <button id="reset" class="btn">Reset view</button>
  </div>

  <div class="grid two">
    <div class="card">
      <h3>Top keywords</h3>
      <canvas id="chartKeywords"></canvas>
      <div class="legend">Count of <code>primary_keyword</code> within current filters.</div>
    </div>
    <div class="card">
      <h3>Signals by hour of day</h3>
      <canvas id="chartHours"></canvas>
      <div class="legend">Hour is derived from the article’s published timestamp (local time).</div>
    </div>
  </div>

  <div class="grid three" style="margin-top:16px">
    <div class="card">
      <h3>By category</h3>
      <canvas id="chartCats"></canvas>
    </div>
    <div class="card">
      <h3>By status</h3>
      <canvas id="chartStats"></canvas>
    </div>
    <div class="card">
      <h3>Top sources</h3>
      <canvas id="chartSources"></canvas>
      <div class="legend">Domain extracted from <code>link</code>.</div>
    </div>
  </div>
</div>

<script>
/* --- theme --- */
(()=>{ const s=localStorage.getItem("fe_theme"); if(s==="dark") document.documentElement.classList.add("dark"); })();
document.getElementById("dark").onclick=()=>{document.documentElement.classList.toggle("dark");localStorage.setItem("fe_theme",document.documentElement.classList.contains("dark")?"dark":"light");};

/* --- helpers --- */
const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
function hostOf(u){ try{ return new URL(u).host.replace(/^www\./,''); }catch{return ""; } }
function hourOf(iso){ const d=new Date(iso); return isNaN(d)?null:d.getHours(); }
function inRange(iso, from, to){
  const t = Date.parse(iso||""); if(isNaN(t)) return false;
  if(from && t < new Date(from).setUTCHours(0,0,0,0)) return false;
  if(to   && t > new Date(to).setUTCHours(23,59,59,999)) return false;
  return true;
}

/* --- state --- */
let rowsAll = [];
let charts = {};
const els = {
  cat:document.getElementById('cat'),
  stat:document.getElementById('stat'),
  from:document.getElementById('from'),
  to:document.getElementById('to'),
  quick:document.getElementById('quick'),
  clear:document.getElementById('clear'),
  topN:document.getElementById('topN'),
  topNVal:document.getElementById('topNVal'),
  kwSearch:document.getElementById('kwSearch'),
  reset:document.getElementById('reset'),
};

/* --- filters --- */
function getFiltered(){
  const c = els.cat.value, s = els.stat.value, f=els.from.value, t=els.to.value;
  return rowsAll.filter(r=>{
    if(c && r.category!==c) return false;
    if(s && (r.status||'').toLowerCase()!==s) return false;
    if(f || t){ if(!inRange(r.published, f, t)) return false; }
    return true;
  });
}
els.quick.onchange = ()=>{
  const d = parseInt(els.quick.value)||0;
  if(!d){ els.from.value=""; els.to.value=""; return; }
  const today = new Date();
  const start = new Date(today.getTime()-d*86400000);
  els.from.value = start.toISOString().slice(0,10);
  els.to.value = today.toISOString().slice(0,10);
  render();
};
els.clear.onclick = ()=>{ els.cat.value=""; els.stat.value=""; els.from.value=""; els.to.value=""; els.quick.value=""; els.kwSearch.value=""; render(); };
['cat','stat','from','to'].forEach(id => els[id].onchange=render);
els.topN.oninput = ()=>{ els.topNVal.textContent = els.topN.value; render(); };
els.kwSearch.oninput = ()=> render();
els.reset.onclick = ()=>{ els.topN.value=30; els.topNVal.textContent="30"; els.kwSearch.value=""; render(); };

/* --- chart helpers --- */
function makeOrUpdate(id, type, data, opt){
  const ctx = document.getElementById(id);
  if(charts[id]){ charts[id].data = data; charts[id].options = opt; charts[id].update(); return; }
  charts[id] = new Chart(ctx, {type, data, options:opt});
}
function palette(n){
  // neutral palette that works in light & dark
  const base = ['#2563eb','#0891b2','#10b981','#84cc16','#f59e0b','#ef4444','#a855f7','#ec4899','#14b8a6','#22c55e','#eab308'];
  const out = []; for(let i=0;i<n;i++) out.push(base[i%base.length]); return out;
}

/* --- render --- */
function render(){
  const rows = getFiltered();

  // Top keywords (from primary_keyword)
  const kwMap = new Map();
  for(const r of rows){ const k=(r.primary_keyword||"").trim(); if(!k) continue;
    kwMap.set(k,(kwMap.get(k)||0)+1);
  }
  let kw = [...kwMap.entries()];
  const q = els.kwSearch.value.trim().toLowerCase();
  if(q) kw = kw.filter(([k])=>k.toLowerCase().includes(q));
  kw.sort((a,b)=>b[1]-a[1]);
  kw = kw.slice(0, parseInt(els.topN.value,10));
  makeOrUpdate('chartKeywords','bar',{
    labels: kw.map(([k])=>k),
    datasets:[{label:'count', data: kw.map(([,v])=>v), backgroundColor: palette(kw.length)}]
  },{
    responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--fg')}},y:{beginAtZero:true}}
  });

  // Hour-of-day histogram
  const hours = Array(24).fill(0);
  for(const r of rows){ const h=hourOf(r.published); if(h!==null) hours[h]++; }
  makeOrUpdate('chartHours','bar',{
    labels: [...Array(24).keys()].map(h=>`${String(h).padStart(2,'0')}:00`),
    datasets:[{label:'signals', data: hours, backgroundColor: palette(1)[0]}]
  },{
    responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}
  });

  // Category distribution
  const cats = ['fashion','beauty','wellness'];
  const catCounts = cats.map(c=>rows.filter(r=>r.category===c).length);
  makeOrUpdate('chartCats','doughnut',{
    labels: cats, datasets:[{data:catCounts, backgroundColor: palette(cats.length)}]
  },{responsive:true});

  // Status distribution
  const stats = ['emerging','bubbling','mainstream'];
  const statCounts = stats.map(s=>rows.filter(r=>(r.status||'').toLowerCase()===s).length);
  makeOrUpdate('chartStats','doughnut',{
    labels: stats, datasets:[{data:statCounts, backgroundColor: palette(stats.length)}]
  },{responsive:true});

  // Top sources (domains)
  const srcMap = new Map();
  for(const r of rows){ const h = hostOf(r.link); if(!h) continue; srcMap.set(h,(srcMap.get(h)||0)+1); }
  const srcPairs = [...srcMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
  makeOrUpdate('chartSources','bar',{
    labels: srcPairs.map(([h])=>h),
    datasets:[{label:'count', data: srcPairs.map(([,v])=>v), backgroundColor: palette(srcPairs.length)}]
  },{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}});
}

/* --- load CSV --- */
function load(){
  const bust = new Date().toISOString().slice(0,10);
  fetch('signals_simple.csv?ts='+bust)
    .then(r=>r.text())
    .then(csv=>Papa.parse(csv,{header:true,skipEmptyLines:true}))
    .then(res=>{ rowsAll=res.data; render(); })
    .catch(()=> alert('Failed to load signals_simple.csv'));
}
load();
</script>
