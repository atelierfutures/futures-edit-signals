<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Futures Edit â€” Tags, Trends & Signals</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#fff; --fg:#0f172a; --muted:#6b7280;
    --card:#fff; --border:#e5e7eb; --pill:#f7f7fb; --shadow:0 12px 30px rgba(15,23,42,.06);
    --bar-h:84px;
    /* designy palette */
    --ink:#1c1c29; --peri:#7ea5e3; --mauve:#d4a5c3;
    --hdr-bg:linear-gradient(180deg, rgba(250,250,255,.92), rgba(250,250,255,.70));
    --hdr-ring:rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:var(--hdr-bg);border-bottom:1px solid var(--border);height:var(--bar-h);display:flex;align-items:center;gap:12px;padding:0 18px;z-index:10;backdrop-filter:saturate(180%) blur(10px)}
  h1{margin:0;font-weight:800;font-size:18px;letter-spacing:.2px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.45rem .7rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827;box-shadow: inset 0 0 0 2px var(--hdr-ring);}
  main{max-width:1120px;margin:22px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:1100px){ .grid-2{grid-template-columns:1.4fr .9fr} .grid-2-even{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  h2{margin:0 0 8px 0;font:800 18px/1.2 inherit}
  h3{margin:0 0 6px 0;font:700 15px/1.2 inherit}
  small,.muted{color:var(--muted)}
  .chart-wrap{height:340px}
  .chart-wrap-sm{height:180px}
  .mini{max-width:100%}
  .mini.thin{height:86px !important}
  .mini.short{height:180px !important}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:left;vertical-align:top}
  thead th{background:#f9fafb;border-bottom:1px solid var(--border)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .select,.input{border:1px solid var(--border);border-radius:12px;padding:9px 12px;background:#fff;box-shadow:var(--shadow)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:.55rem .8rem;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
  .btn:active{transform:translateY(1px)}
  .legend{color:var(--muted);font-size:12px;margin-top:6px}
  .tags-cloud{display:flex;flex-wrap:wrap;gap:8px}
  .tag-pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:12px;color:#111827}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .notes{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fcfcfd;margin-top:10px}
  .flag{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
  .dot{width:10px;height:10px;border-radius:999px;margin-top:5px}
  .warn{background:#f59e0b} .ok{background:#22c55e} .infoDot{background:#3b82f6}
</style>

<header>
  <h1>The Futures Edit â€” Tags, Trends & Signals</h1>
  <span class="pill" id="dataset-meta">loadingâ€¦</span>
  <span style="flex:1"></span>
  <a href="https://github.com/atelierfutures/futures-edit-signals" target="_blank" rel="noopener" class="btn">Repository</a>
  <a href="tags.html" target="_blank" rel="noopener" class="btn">Tags graph</a>
  <a href="https://atelierfutures.github.io/futures-edit-signals/advanced.html" target="_blank" rel="noopener" class="btn">Advanced Analytics</a>
</header>

<main class="grid">
  <section class="card">
    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:8px;">
      <h2>Momentum Score â€” Breakouts (Top 15)</h2>
      <small id="momentum-meta" class="muted"></small>
    </div>
    <div class="chart-wrap"><canvas id="momentumChart"></canvas></div>
  </section>

  <section class="grid grid-2 card" style="gap:16px;">
    <div>
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0">Top signals (Top 30)</h2>
        <label class="muted">Filterâ€¦ <input id="kwSearch" type="search" class="input" placeholder="type to filter bar" style="width:220px"></label>
      </div>
      <div id="signals-meta" class="muted" style="margin-bottom:6px;"></div>
      <div class="chart-wrap"><canvas id="signalsChart"></canvas></div>
      <small class="muted" style="display:block;margin-top:6px;">Click a bar to analyze the signal on the right.</small>
    </div>

    <aside>
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0">Signal Insights</h2>
        <a class="btn" id="openList" target="_blank" rel="noopener">Open in list</a>
      </div>
      <div id="signal-title" style="font:800 18px/1.2 ui-sans-serif,system-ui;">Select a signal â†’</div>
      <div class="row" id="kpis" style="display:none;margin-top:8px;">
        <span class="pill" id="kpi-score">Trend: â€“</span>
        <span class="pill" id="kpi-momentum">Momentum: â€“</span>
        <span class="pill" id="kpi-volume">Volume: â€“</span>
        <span class="pill" id="kpi-growth">Growth: â€“</span>
        <span class="pill" id="kpi-lastseen">Last: â€“</span>
      </div>

      <canvas id="chartKwStatus" class="mini thin" aria-label="Status mix"></canvas>
      <div class="legend">Status mix for the selected signal.</div>

      <h3 style="margin-top:8px">Search intent (GSC)</h3>
      <canvas id="chartIntent" class="mini short"></canvas>
      <div id="intentMeta" class="legend"></div>

      <h3 style="margin-top:8px">Top questions & Answer Gap</h3>
      <div class="row"><span class="pill" id="gapBadge">Answer Gap: â€“</span></div>
      <ul id="qList" class="tags-cloud" style="gap:6px; margin-top:8px;"></ul>

      <div class="divider"></div>
      <h3>Latest articles</h3>
      <div id="articles-list" class="muted">No signal selected.</div>

      <div class="notes" id="guardrailsBox" style="display:none;margin-top:12px;">
        <h3 style="margin:0 0 6px 0">Guardrails & context</h3>
        <div id="guards"></div>
      </div>

      <details class="notes" style="margin-top:12px;">
        <summary><strong>Content Kit</strong></summary>
        <div class="muted" style="margin-top:8px;">
          <div><b>Executive takeaway</b><pre id="kit-takeaway"></pre></div>
          <div><b>Newsletter blurb</b><pre id="kit-news"></pre></div>
          <div><b>LinkedIn long post</b><pre id="kit-li"></pre></div>
          <div><b>Social hooks (6)</b><pre id="kit-hooks"></pre></div>
          <div><b>KPIs to track</b><pre id="kit-kpis"></pre></div>
        </div>
      </details>
    </aside>
  </section>

  <section class="grid grid-2-even card">
    <div>
      <h2>Fastest-rising signals (current vs previous)</h2>
      <div class="chart-wrap-sm"><canvas id="risersChart"></canvas></div>
    </div>
    <div>
      <h2>Newcomer signals (first appearances)</h2>
      <ul id="newcomersList" class="tags-cloud" style="margin-top:6px;"></ul>
    </div>
  </section>

  <section class="grid grid-2-even card">
    <div>
      <h2>Status mix by category</h2>
      <div class="chart-wrap-sm"><canvas id="mixChart"></canvas></div>
      <div class="legend">100% stacked bars: emerging / bubbling / mainstream (design palette).</div>
    </div>
    <div>
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <h2>Category insight</h2>
        <select id="insightMode" class="select" style="width:220px">
          <option value="concentration" selected>Signal concentration</option>
          <option value="newcomers">Newcomer share</option>
          <option value="gainers">Gainer share</option>
          <option value="cross">Cross-vertical</option>
        </select>
      </div>
      <div class="chart-wrap-sm"><canvas id="insightChart"></canvas></div>
      <div id="insightLegend" class="legend"></div>
    </div>
  </section>
</main>

<!-- Safe fallbacks so the page never renders blank -->
<script type="text/plain" id="embedded-signals">
primary_keyword,category,status,published,title,link,growth_rate,trend_score
"longevity","wellness","mainstream","2025-09-12","How microdosing GLP-1 drugs became a longevity â€˜crazeâ€™ - The Washington Post","https://www.washingtonpost.com/health/2025/09/03/weight-loss-drugs-longevity/",27,58
"augmented try-on","beauty","bubbling","2025-09-11","AR Try-On Boosts Conversion","https://example.com/ar-try-on-stats",27,65
"blue beauty","beauty","emerging","2025-08-30","Blue Beauty: Beyond Green","https://example.com/blue-beauty-future",35,60
"quiet luxury","fashion","mainstream","2025-07-05","Quiet Luxury Is Still Here","https://example.com/quiet-luxury",5,52
</script>

<script type="text/plain" id="embedded-gsc">
signal,query,impressions,clicks,date
"longevity","what is glp-1 longevity",1200,60,"2025-09-01"
"longevity","how to start longevity routine",900,45,"2025-09-03"
"longevity","longevity supplements review",650,30,"2025-08-28"
"longevity","best longevity diet",520,22,"2025-09-04"
"longevity","longevity vs biohacking",300,10,"2025-08-31"
"longevity","longevity near me",120,8,"2025-09-05"
"augmented try-on","what is ar try on",800,40,"2025-09-02"
"augmented try-on","how to integrate ar try on shopify",420,18,"2025-09-06"
</script>

<script>
/* ---------- Palette ---------- */
const PALETTE=['#1c1c29','#58506b','#7a7281','#a78fb3','#d4a5c3','#f2b5a8','#f0c38e','#c2d39b','#86c5a6','#6bb7b6','#5aa3c2','#7ea5e3','#b4c2f2','#d7d3f2'];
const STATUS_COLORS={ emerging:getCSS('--peri','#7ea5e3'), bubbling:getCSS('--mauve','#d4a5c3'), mainstream:getCSS('--ink','#1c1c29') };
function getCSS(name,fallback){ const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim(); return v||fallback; }
function palette(n){ const out=[]; for(let i=0;i<n;i++) out.push(PALETTE[i%PALETTE.length]); return out; }

/* ---------- Helpers ---------- */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const escRe=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
function parseCSV(text){ return Papa.parse(text,{header:true,skipEmptyLines:true}).data; }
async function loadCSVChecked(url, fallbackId){
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('http '+r.status);
    const t=await r.text();
    const rows=parseCSV(t);
    const hasCols = rows.some(x=> x.primary_keyword || x.keyword); // sanity
    if(!hasCols) throw new Error('bad-columns');
    return {rows, source:'csv'};
  }catch(e){
    const emb=(document.getElementById(fallbackId)?.textContent||'').trim();
    const rows=parseCSV(emb);
    return {rows, source:'sample'};
  }
}
async function loadMaybe(url, fallbackId){
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('http '+r.status);
    const t=await r.text(); const rows=parseCSV(t);
    return rows.length ? rows : parseCSV((document.getElementById(fallbackId)?.textContent||'').trim());
  }catch(e){
    return parseCSV((document.getElementById(fallbackId)?.textContent||'').trim());
  }
}
function recencyScoreFromDateStr(s){ const now=new Date(); const d=new Date(s); if(isNaN(d))return 0; const days=(now-d)/(1000*60*60*24); return clamp(100 - (days/90)*100, 0, 100); }
function minmaxNormalize(values){ const a=values.map(v => (isFinite(+v)?+v:0)); const mn=Math.min(...a), mx=Math.max(...a); if(!isFinite(mn)||!isFinite(mx)||mx===mn) return a.map(_=>0); return a.map(v => ((v-mn)/(mx-mn))*100); }
function hostOf(u){ try{ return new URL(u).host.replace(/^www\./,''); }catch{return ""; } }
function inRange(iso, from, to){ const t=Date.parse(iso||""); if(isNaN(t)) return false; if(from && t < new Date(from).setUTCHours(0,0,0,0)) return false; if(to && t > new Date(to).setUTCHours(23,59,59,999)) return false; return true; }

/* ---------- Normalization ---------- */
const KW_MAP=new Map([['anti aging','longevity'],['anti-ageing','longevity'],['retinol routine','retinoid routines'],['skin cycling','retinoid routines'],['lip oils','lip oil'],['biohacking','longevity'],['sleep tech','sleep optimization'],['old money','quiet luxury'],['stealth wealth','quiet luxury'],['westernwear','western'],['cowboy core','western'],['gen ai','ai'],['generative ai','ai']]);
const KW_STOP=new Set(['trend','trends','report','collection','editorial','new','drop','style','styled','look','looks','runway','season','fall','winter','spring','summer','2024','2025','brand','product','products','line','launch','limited','best','top','dress','dresses','shirt','shirts','pants','jeans','skirt','skirts','bag','bags','shoes']);
function normalizeKw(raw){ if(!raw) return ''; let s=String(raw).toLowerCase().trim().replace(/[â€“â€”]/g,'-').replace(/\s+/g,' ').replace(/\s-\s/g,'-'); if(s.endsWith('s')&&s.length>4)s=s.slice(0,-1); if(KW_MAP.has(s)) s=KW_MAP.get(s); s=s.replace(/^[-_.,:;]+|[-_.,:;]+$/g,''); if(s.length<3||KW_STOP.has(s)) return ''; return s; }
function getKw(r){ return normalizeKw(r.primary_keyword || r.keyword || ''); }

/* ---------- GSC (intent) ---------- */
const INTENTS=[{key:'what_is',re:/\bwhat(\s+is|â€™s|'s)\b/i,label:'what is'},{key:'how_to',re:/\bhow\s+to\b/i,label:'how to'},{key:'best',re:/\bbest\b/i,label:'best'},{key:'vs',re:/\bvs\b|\bversus\b/i,label:'vs'},{key:'review',re:/\breview|reviews|rating|ratings\b/i,label:'review'},{key:'near_me',re:/\bnear\s+me\b/i,label:'near me'}];
function classifyIntent(q){ for(const t of INTENTS){ if(t.re.test(q)) return t.key; } return 'other'; }
function gscForSignal(rows, signal){ const s=normalizeKw(signal); return rows.filter(r => normalizeKw(r.signal||r.keyword||'')===s); }
function intentStack(rows){ const buckets={what_is:0,how_to:0,best:0,vs:0,review:0,near_me:0,other:0}; let tot=0; rows.forEach(r=>{ const imp=+r.impressions||0; const q=String(r.query||''); const k=classifyIntent(q); buckets[k]+=imp; tot+=imp; }); const pct={}; Object.keys(buckets).forEach(k=> pct[k]= tot? Math.round(buckets[k]/tot*100):0 ); return {buckets,pct,total:tot}; }
function topQuestions(rows,limit=10){ return rows.filter(r=>/\b(what|how|why|can|should|does|is|are)\b/i.test(r.query||'')).sort((a,b)=>(+b.impressions||0)-(+a.impressions||0)).slice(0,limit).map(r=>({q:r.query,imp:+r.impressions||0})); }
function answerGapPct(signalRows,gscRows){ const totImp=gscRows.reduce((s,r)=>s+(+r.impressions||0),0)||0; const qImp=gscRows.filter(r=>/\b(what|how|why|can|should|does|is|are)\b/i.test(r.query||'')).reduce((s,r)=>s+(+r.impressions||0),0); const qShare=totImp?(qImp/totImp*100):0; const ex=/(how|why|what|guide|explained|faq|q&a)/i; const titles=signalRows.map(r=>String(r.title||'')); const answered=titles.filter(t=>ex.test(t)).length; const aShare=titles.length?(answered/titles.length*100):0; return Math.max(0,Math.round(qShare-aShare)); }

/* ---------- App state ---------- */
const TOP=30;
let SIGNAL_ROWS=[], GSC_ROWS=[];
let trendScores=[], momentumScores=[], volN=[], groN=[], recN=[];
let COUNTS=null, listTop=[], charts={}, selected=null;

/* ---------- Boot ---------- */
(async function(){
  const bust=new Date().toISOString().slice(0,10);
  const {rows:signals, source:sSrc}=await loadCSVChecked('signals_simple.csv?ts='+bust,'embedded-signals');
  const gsc = await loadMaybe('gsc_queries.csv','embedded-gsc');
  SIGNAL_ROWS=signals; GSC_ROWS=gsc;

  document.getElementById('dataset-meta').textContent=`${SIGNAL_ROWS.length} rows â€¢ ${new Date().toISOString().slice(0,10)} â€¢ ${sSrc}`;

  const get=(r,k)=>r[k] ?? r[k?.toLowerCase?.()] ?? r[k?.toUpperCase?.()];
  const volumes =SIGNAL_ROWS.map(r=>isFinite(+get(r,'volume'))?+get(r,'volume'):0);
  const growths0=SIGNAL_ROWS.map(r=>isFinite(+get(r,'growth_rate'))?+get(r,'growth_rate'):0);
  const growths =growths0.map(v=>Math.max(0,v));
  const recency =SIGNAL_ROWS.map(r=>recencyScoreFromDateStr(get(r,'last_seen')||get(r,'published')||''));
  volN=minmaxNormalize(volumes); groN=minmaxNormalize(growths); recN=recency;
  trendScores = volN.map((_,i)=>Math.round(0.40*volN[i] + 0.40*groN[i] + 0.20*recN[i]));
  const noveltyN = volN.map(v=>100 - v);
  momentumScores = volN.map((_,i)=>Math.round(0.55*groN[i] + 0.35*recN[i] + 0.10*noveltyN[i]));

  /* Momentum top 15 */
  const keywords=SIGNAL_ROWS.map(r=>String(get(r,'primary_keyword')||get(r,'keyword')||'').trim());
  const rankedMomentum = keywords.map((k,i)=>({k:normalizeKw(k), m:momentumScores[i]})).filter(d=>d.k).sort((a,b)=>b.m-a.m).slice(0,15);
  makeBar('momentumChart', rankedMomentum.map(d=>d.k), rankedMomentum.map(d=>d.m), 'Momentum (0â€“100)');
  document.getElementById('momentum-meta').textContent=`(Top ${rankedMomentum.length})`;

  /* Signals â€” counts */
  COUNTS=new Map();
  SIGNAL_ROWS.forEach(r=>{ const k=getKw(r); if(!k) return; COUNTS.set(k,(COUNTS.get(k)||0)+1); });
  listTop=[...COUNTS.entries()].sort((a,b)=>b[1]-a[1]).slice(0,TOP);
  document.getElementById('signals-meta').textContent=`(${listTop.length} signals)`;
  const sigChart=makeBar('signalsChart', listTop.map(d=>d[0]), listTop.map(d=>d[1]), 'Count', (i)=>selectSignal(listTop[i][0]));
  if(listTop.length){ selectSignal(listTop[0][0]); }

  /* Search box */
  document.getElementById('kwSearch').oninput=(e)=>{
    const q=e.target.value.trim(); let arr=[...COUNTS.entries()];
    if(q){ const re=new RegExp(escRe(q),'i'); arr=arr.filter(([k])=>re.test(k)); }
    arr.sort((a,b)=>b[1]-a[1]); arr=arr.slice(0,TOP);
    sigChart.data.labels=arr.map(d=>d[0]); sigChart.data.datasets[0].data=arr.map(d=>d[1]); sigChart.update();
  };

  /* Risers/Newcomers */
  const {curFrom,curTo,prevFrom,prevTo}=windowBounds();
  const curRows=rowsInRange(SIGNAL_ROWS,curFrom,curTo);
  const prevRows=rowsInRange(SIGNAL_ROWS,prevFrom,prevTo);
  const risers=fastestRisers(curRows,prevRows,12);
  makeBar('risersChart', risers.map(r=>r.k), risers.map(r=>r.delta), 'Î” vs previous');
  const newbies=newcomerKeywords(curRows,prevRows,20);
  document.getElementById('newcomersList').innerHTML =
    newbies.map(n=>`<span class="tag-pill">${n.k} â€¢ +${n.c}</span>`).join('') || `<span class="muted">No newcomers.</span>`;

  /* Status mix by category */
  const mix=statusMixByCategory(SIGNAL_ROWS);
  new Chart(document.getElementById('mixChart'),{
    type:'bar',
    data:{labels:mix.cats,datasets:[
      {label:'emerging',data:mix.perc.map(r=>r[0]),backgroundColor:STATUS_COLORS.emerging,borderRadius:6},
      {label:'bubbling',data:mix.perc.map(r=>r[1]),backgroundColor:STATUS_COLORS.bubbling,borderRadius:6},
      {label:'mainstream',data:mix.perc.map(r=>r[2]),backgroundColor:STATUS_COLORS.mainstream,borderRadius:6}
    ]},
    options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true,max:100}},plugins:{legend:{position:'bottom'}}}
  });

  /* Category insight switcher */
  const insightSel=document.getElementById('insightMode');
  const insightLegend=document.getElementById('insightLegend');
  const insightCtx=document.getElementById('insightChart').getContext('2d');
  let insightChart=null;
  function renderInsight(mode){
    let data, legend;
    if(mode==='concentration'){ data=concentrationByCategory(SIGNAL_ROWS); legend='Head share = % of mentions captured by top 5 signals (lower = more fragmented / whitespace).'; }
    else if(mode==='newcomers'){ data=newcomerShareByCategory(curRows,prevRows); legend='Share of signals present now but not in previous window.'; }
    else if(mode==='gainers'){ data=gainerShareByCategory(curRows,prevRows); legend='Share of signals with positive Î” vs previous window.'; }
    else{ data=crossVerticalShare(SIGNAL_ROWS); legend='Share of signals that also appear in â‰¥1 other category.'; }
    if(insightChart) insightChart.destroy();
    insightChart=new Chart(insightCtx,{type:'bar',data:{labels:data.cats,datasets:[{label:'%',data:data.values,backgroundColor:palette(data.cats.length),borderRadius:8}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}});
    insightLegend.textContent=legend;
  }
  renderInsight('concentration');
  insightSel.onchange=e=>renderInsight(e.target.value);

  /* helpers inside */
  function makeBar(id, labels, data, lab, onClickIndex){
    const ctx=document.getElementById(id).getContext('2d'); if(charts[id]) charts[id].destroy?.();
    const ch=new Chart(ctx,{ type:'bar', data:{labels,datasets:[{label:lab, data, backgroundColor:palette(labels.length), borderRadius:8, barThickness:16}]},
      options:{responsive:true, maintainAspectRatio:false, indexAxis:'y', scales:{x:{beginAtZero:true}}, plugins:{legend:{display:false}},
      onClick(_,els){ if(els?.length){ onClickIndex?.(els[0].index); } }} });
    charts[id]=ch; return ch;
  }
})();

/* ---------- Detail panel ---------- */
function selectSignal(name){
  selected=name;
  document.getElementById('signal-title').textContent=name;

  const rows=SIGNAL_ROWS.filter(r=>getKw(r)===name);
  // KPIs
  const score = mean(rows.map(r=>+r.trend_score||0));
  const vol = rows.length;
  const growth = mean(rows.map(r=> +r.growth_rate || 0));
  const last = rows.map(r=>r.last_seen||r.published||'').sort().slice(-1)[0] || 'â€“';

  show('kpis', true);
  text('kpi-score', `Trend: ${isFinite(score)?Math.round(score):'â€“'}`);
  text('kpi-momentum', `Momentum: ${estimateMomentum(rows)}`);
  text('kpi-volume', `Volume: ${vol}`);
  text('kpi-growth', `Growth: ${isFinite(growth)?growth+'%':'â€“'}`);
  text('kpi-lastseen', `Last: ${last}`);

  const p=new URLSearchParams(); p.set('q',name); p.set('view','table');
  document.getElementById('openList').href='./?'+p.toString();

  // status thin bar
  const stats=['emerging','bubbling','mainstream'];
  const counts=stats.map(s=> rows.filter(r=>String(r.status||'').toLowerCase()===s).length);
  new Chart(document.getElementById('chartKwStatus').getContext('2d'),{
    type:'bar',
    data:{labels:['mix'],datasets:[
      {label:'emerging',data:[counts[0]],backgroundColor:STATUS_COLORS.emerging,borderRadius:6},
      {label:'bubbling',data:[counts[1]],backgroundColor:STATUS_COLORS.bubbling,borderRadius:6},
      {label:'mainstream',data:[counts[2]],backgroundColor:STATUS_COLORS.mainstream,borderRadius:6}
    ]},
    options:{indexAxis:'y',scales:{x:{stacked:true,beginAtZero:true}, y:{stacked:true,ticks:{display:false},grid:{display:false}}},plugins:{legend:{position:'bottom'}}}
  });

  // GSC: intent + questions + gap
  const gsc=gscForSignal(GSC_ROWS,name);
  const stack=intentStack(gsc);
  const order=['what_is','how_to','best','vs','review','near_me','other'];
  new Chart(document.getElementById('chartIntent').getContext('2d'),{
    type:'bar',
    data:{labels:['intent'],datasets:order.map((k,i)=>({label:(INTENTS.find(t=>t.key===k)?.label || (k==='other'?'other':k)),data:[stack.pct[k]||0],backgroundColor:PALETTE[i%PALETTE.length],borderRadius:6}))},
    options:{indexAxis:'y',scales:{x:{stacked:true,beginAtZero:true,max:100}, y:{stacked:true,ticks:{display:false},grid:{display:false}}},plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:(c)=>`${c.dataset.label}: ${c.parsed.x}%`}}}}
  });
  document.getElementById('intentMeta').textContent = stack.total ? `${stack.total.toLocaleString()} impressions across queries` : 'No GSC rows for this signal (sample used or none).';
  const qs=topQuestions(gsc,8);
  document.getElementById('qList').innerHTML = qs.length
    ? qs.map(r=>`<span class="tag-pill"><a href="https://www.google.com/search?q=${encodeURIComponent(r.q)}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit">${r.q}</a> â€¢ ${r.imp.toLocaleString()}</span>`).join('')
    : `<span class="muted">No question-type queries.</span>`;
  const gap=answerGapPct(rows,gsc); text('gapBadge',`Answer Gap: ${gap}%`);

  // Articles (latest 12)
  const list=document.getElementById('articles-list');
  const latest=rows.slice().sort((a,b)=>(Date.parse(b.published||b.last_seen||0)||0)-(Date.parse(a.published||a.last_seen||0)||0)).slice(0,12);
  list.innerHTML = latest.map(r=>{
    const d=(r.published||r.last_seen||"").slice(0,10); const t=r.title||"(untitled)"; const u=r.link||'#';
    return `<div style="padding:10px 0;border-bottom:1px dashed var(--border)"><a href="${u}" target="_blank" rel="noopener" style="font-weight:600;text-decoration:none;color:#111827;">${t}</a><div class="muted" style="font-size:12px;">${hostOf(u)} ${d? 'â€¢ '+d : ''}</div></div>`;
  }).join('') || `<span class="muted">No recent articles.</span>`;

  // Guardrails
  renderGuardrails(name, rows);

  // Content Kit (concise)
  const cat=topCat(rows); const imps=implicationsFromCat(cat); const kpis=kpisFromCat(cat);
  text('kit-takeaway', `${name} â€” ${imps[0]}. Total ${rows.length}, avg trend ${mean(rows.map(r=>+r.trend_score||0))}, top category ${cat}.`);
  text('kit-news', `**${name}** â€” ${imps[0]}. Why it matters: ${imps.join('; ')}. Sources: ${latest.slice(0,3).map(r=>hostOf(r.link||'')).filter(Boolean).join(', ')}. Reply for a one-pager or pilot brief.`);
  text('kit-li', `âš¡ ${name}\nâ€¢ ${imps.join('\nâ€¢ ')}\n\nKPIs: ${kpis.join(' â€¢ ')}\nðŸ‘‰ DM for the pilot checklist.`);
  text('kit-hooks', [`${name}: the micro-trend brands keep missing`, `${name} â†’ from hype to impact`, `3 ways to activate ${name}`].join('\n'));
  text('kit-kpis', kpis.join(' â€¢ '));
}

/* ---------- Small utils ---------- */
function text(id,s){ const el=document.getElementById(id); if(el) el.textContent=s; }
function show(id,vis){ const el=document.getElementById(id); if(el) el.style.display = vis ? '' : 'none'; }
function mean(a){ const b=a.filter(n=>isFinite(n)); if(!b.length) return 0; return Math.round((b.reduce((x,y)=>x+y,0)/b.length)*100)/100; }
function topCat(rows){ const m=new Map(); rows.forEach(r=>{ const c=r.category||''; if(c) m.set(c,(m.get(c)||0)+1); }); let best='â€“',cnt=-1; m.forEach((v,k)=>{if(v>cnt){cnt=v;best=k;}}); return best; }
function rowsInRange(all,from,to){ const A=from.toISOString().slice(0,10), B=to.toISOString().slice(0,10); return all.filter(r=>inRange(r.published||r.last_seen,A,B)); }
function windowBounds(){ const today=new Date(); const curTo=today; const curFrom=new Date(today.getTime()-90*86400000); const lenMs=curTo-curFrom; const prevTo=new Date(curFrom.getTime()-1); const prevFrom=new Date(prevTo.getTime()-lenMs+1); return {curFrom,curTo,prevFrom,prevTo}; }
function mapCounts(rows){ const m=new Map(); rows.forEach(r=>{ const k=getKw(r); if(!k) return; m.set(k,(m.get(k)||0)+1); }); return m; }
function fastestRisers(curRows,prevRows,top=12){ const cur=mapCounts(curRows), prev=mapCounts(prevRows); const set=new Set([...cur.keys(),...prev.keys()]); const arr=[]; set.forEach(k=>{ const c=cur.get(k)||0, p=prev.get(k)||0; const d=c-p; if(c===0) return; arr.push({k,delta:d,c,p}); }); arr.sort((a,b)=> b.delta - a.delta || b.c - a.c); return arr.slice(0,top); }
function newcomerKeywords(curRows,prevRows,limit=20){ const cur=mapCounts(curRows), prev=mapCounts(prevRows), out=[]; cur.forEach((c,k)=>{ if(c>0 && !prev.has(k)) out.push({k,c}); }); out.sort((a,b)=> b.c - a.c); return out.slice(0,limit); }
function statusMixByCategory(rows){ c
